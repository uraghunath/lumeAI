<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LumeAI Bank Portal - Loan Processing System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            padding: 32px 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated background gradient */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.2), transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(168, 85, 247, 0.15), transparent 50%);
            animation: gradientShift 15s ease infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gradientShift {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Glass morphism header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 28px 40px;
            border-radius: 24px;
            margin-bottom: 28px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.12),
                0 2px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 32px;
            transition: all 0.3s ease;
        }

        .header:hover {
            box-shadow: 
                0 12px 48px rgba(0, 0, 0, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .header h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #64748b;
            font-size: 15px;
            font-weight: 400;
        }

        .header > div {
            flex: 1;
            min-width: 0;
        }

        .bank-selector {
            padding: 18px 60px 18px 26px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #000000 !important;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 700;
            border: 3px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 
                0 10px 30px rgba(102, 126, 234, 0.6),
                0 0 0 4px rgba(102, 126, 234, 0.15),
                inset 0 2px 0 rgba(255, 255, 255, 0.2);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5 7.5L10 12.5L15 7.5' stroke='black' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 22px center;
            background-size: 20px;
            min-width: 260px;
            flex-shrink: 0;
            z-index: 100;
            position: relative;
            text-shadow: none;
            animation: bankPulse 2s ease-in-out 3;
            opacity: 1 !important;
        }

        .bank-selector:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 12px 36px rgba(102, 126, 234, 0.6),
                0 0 0 6px rgba(102, 126, 234, 0.15);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .bank-selector:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.7);
            box-shadow: 
                0 12px 40px rgba(102, 126, 234, 0.7),
                0 0 0 6px rgba(102, 126, 234, 0.2);
        }

        /* Modern options for bank selector - compact size */
        .bank-selector option {
            background: #ffffff !important;
            color: #1e293b !important;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 600;
            line-height: 1.5;
        }

        .bank-selector option:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
            color: #0f172a !important;
            font-weight: 700;
        }

        .bank-selector option:checked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            font-weight: 700;
        }

        /* Force text visibility in bank selector */
        .bank-selector * {
            color: inherit;
        }

        /* Ensure bank selector text is always visible */
        select#bankSelect {
            color: #000000 !important;
            opacity: 1 !important;
            -webkit-text-fill-color: #000000 !important;
            font-weight: 700 !important;
        }

        select#bankSelect option {
            color: #1e293b !important;
            -webkit-text-fill-color: #1e293b !important;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.8fr 1fr;
            gap: 28px;
        }

        /* Modern card with glass effect */
        .card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.12),
                0 2px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 
                0 12px 48px rgba(0, 0, 0, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .card h2 {
            color: #1e293b;
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
            letter-spacing: -0.3px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            color: #475569;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
            letter-spacing: -0.1px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            background: #ffffff;
            color: #1e293b;
            letter-spacing: -0.1px;
        }

        /* Modern select dropdown styling - same as inputs */
        .form-group select,
        select[required] {
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            background-color: #ffffff;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5 7.5L10 12.5L15 7.5' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 48px;
            cursor: pointer;
            font-size: 13px;
        }

        .form-group select:hover,
        select[required]:hover {
            border-color: #cbd5e1;
        }

        .form-group select:focus,
        select[required]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        /* Modern styled options - compact size (applies to ALL selects) */
        .form-group select option,
        select[required] option {
            padding: 10px 14px !important;
            font-size: 13px !important;
            font-weight: 500;
            line-height: 1.5;
            background: #ffffff;
            color: #1e293b;
        }

        .form-group select option:hover,
        select[required] option:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
            color: #0f172a;
            font-weight: 600;
        }

        .form-group select option:checked,
        select[required] option:checked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            font-weight: 700;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-group input:hover {
            border-color: #cbd5e1;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Form Section Styling */
        .form-section {
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .section-heading {
            font-size: 16px;
            color: #475569;
            margin-bottom: 16px;
            font-weight: 600;
            letter-spacing: -0.2px;
        }

        /* Modern buttons */
        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: auto;
            max-width: 280px;
            margin: 20px auto 12px;
            display: block;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.2px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
        }

        /* Result panel with modern animations */
        .result-panel {
            display: none;
            margin-top: 28px;
            padding: 28px;
            border-radius: 20px;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-approved {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #10b981;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
        }

        .result-denied {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2);
        }

        .result-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: -0.3px;
        }

        .result-approved .result-title {
            color: #065f46;
        }

        .result-denied .result-title {
            color: #991b1b;
        }

        .factors-list {
            margin: 20px 0;
        }

        .factor-item {
            display: flex;
            align-items: center;
            padding: 16px;
            margin: 12px 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            font-size: 14px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .factor-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .factor-icon {
            font-size: 22px;
            margin-right: 14px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        .factor-passed {
            color: #10b981;
            background: #d1fae5;
        }

        .factor-failed {
            color: #ef4444;
            background: #fee2e2;
        }

        .bias-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.2);
        }

        .bias-warning-title {
            color: #92400e;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            letter-spacing: -0.2px;
        }

        .bias-warning-icon {
            font-size: 26px;
            margin-right: 12px;
        }

        .bias-groups {
            color: #78350f;
            margin-top: 12px;
            font-size: 14px;
            line-height: 1.8;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 28px;
        }

        .info-panel {
            position: sticky;
            top: 32px;
        }

        /* Modern stats cards */
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 0;
        }

        .stat-box {
            padding: 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 6px;
            font-weight: 500;
            letter-spacing: -0.1px;
        }

        .loading {
            text-align: center;
            padding: 32px;
            color: #64748b;
        }

        .spinner {
            border: 4px solid #f1f5f9;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            margin: 24px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bankPulse {
            0%, 100% { 
                box-shadow: 
                    0 10px 30px rgba(102, 126, 234, 0.6),
                    0 0 0 4px rgba(102, 126, 234, 0.15),
                    inset 0 2px 0 rgba(255, 255, 255, 0.2);
            }
            50% { 
                box-shadow: 
                    0 10px 30px rgba(102, 126, 234, 0.8),
                    0 0 0 8px rgba(102, 126, 234, 0.25),
                    inset 0 2px 0 rgba(255, 255, 255, 0.2);
            }
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            gap: 12px;
            margin-bottom: 0;
            padding-bottom: 0;
            position: relative;
            z-index: 10;
        }

        .tab-button {
            padding: 14px 28px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 12px 12px 0 0;
            color: rgba(255, 255, 255, 0.7);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 1);
        }

        .tab-button.active {
            background: rgba(255, 255, 255, 0.98);
            color: #667eea;
            box-shadow: 0 -4px 20px rgba(102, 126, 234, 0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.8fr 1fr;
            gap: 28px;
        }

        /* Card adjustment for tab integration */
        #application-tab .card,
        #fraud-tab .card {
            border-radius: 0 16px 16px 16px;
            margin-top: 0;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none;
        }

        .success-message {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            border: 2px solid #10b981;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
            animation: slideUp 0.5s ease;
        }

        /* Modern guidelines */
        .guidelines {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 0;
            border: 1px solid #c4b5fd;
        }

        .guidelines h3 {
            color: #5b21b6;
            font-size: 13px;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.2px;
        }

        .guidelines ul {
            margin-left: 20px;
            color: #6b21a8;
            font-size: 13px;
            line-height: 1.7;
        }

        .guidelines li {
            margin-bottom: 5px;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .info-panel {
                position: static;
            }

            .header {
                flex-direction: column;
                gap: 20px;
                align-items: stretch;
            }

            .bank-selector {
                width: 100%;
                min-width: unset;
            }
        }

        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        /* Modern Custom Dropdown */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 14px 16px;
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #1e293b;
            letter-spacing: -0.1px;
        }

        .dropdown-trigger:hover {
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .dropdown-trigger.active {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .selected-text {
            flex: 1;
            color: #1e293b;
        }

        .selected-text.placeholder {
            color: #94a3b8;
        }

        .dropdown-arrow {
            color: #667eea;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }

        .dropdown-trigger.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 1000;
        }

        .dropdown-menu.show {
            max-height: 350px;
            opacity: 1;
            transform: translateY(0);
            overflow-y: auto;
        }

        /* Compact scrollbar for dropdown */
        .dropdown-menu::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-menu::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        .dropdown-section {
            padding: 6px;
        }

        .dropdown-section:not(:last-child) {
            border-bottom: 1px solid #f1f5f9;
        }

        .dropdown-section-label {
            padding: 6px 10px;
            font-size: 10px;
            font-weight: 700;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dropdown-option {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 3px 0;
            background: #ffffff;
        }

        .dropdown-option:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .dropdown-option:active {
            transform: translateX(4px) scale(0.98);
        }

        .option-icon {
            font-size: 18px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .option-content {
            flex: 1;
        }

        .option-title {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
            letter-spacing: -0.2px;
            line-height: 1.3;
        }

        .option-description {
            font-size: 11px;
            color: #64748b;
            line-height: 1.4;
            font-weight: 400;
        }

        /* Close dropdown when clicking outside */
        .dropdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 999;
            display: none;
        }

        .dropdown-overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üè¶ LumeAI Bank Portal</h1>
                <p>Making AI Banking Decisions Transparent, Fair & Explainable</p>
            </div>
            <select class="bank-selector" id="bankSelect">
                <option value="HDFC Bank">üè¶ HDFC Bank</option>
                <option value="SBI">üè¶ State Bank of India</option>
                <option value="ICICI Bank">üè¶ ICICI Bank</option>
                <option value="Axis Bank">üè¶ Axis Bank</option>
            </select>
        </div>

        <!-- Tab Navigation (Outside Grid) -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('application')">
                üìù New Application / Decision
            </button>
            <button class="tab-button" onclick="switchTab('fraud')">
                üö® Synthetic Identity Fraud Detection
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Application Tab Content -->
            <div id="application-tab" class="tab-content active">
            <!-- Application Form -->
            <div class="card">
                <h2>üìù New Application / Decision</h2>
                
                <form id="loanForm">
                    <!-- Customer Details Section -->
                    <div class="form-section">
                        <h3 class="section-heading">üë§ Customer Details</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Lume AI ID *</label>
                                <input type="text" id="customerId" placeholder="e.g., CUST_1763047663724_6094" required 
                                       style="font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 14px; font-weight: 600;"
                                       oninput="fetchCustomerData()">
                            </div>
                            
                            <div class="form-group">
                                <label>Customer Name *</label>
                                <input type="text" id="customerName" placeholder="" required readonly style="cursor: not-allowed;">
                                <small id="nameHelperText" style="display: block; margin-top: 6px; color: #64748b; font-size: 12px;">
                                    <span id="nameLoadingIndicator" style="display: none; color: #667eea; font-weight: 500;">üîÑ Loading from Lume AI app...</span>
                                    <span id="nameLoadedIndicator" style="display: none; color: #7c3aed; font-weight: 500;">‚úì Auto-populated from Lume AI app</span>
                                    <span id="nameErrorIndicator" style="display: none; color: #f97316; font-weight: 500;">‚ö† Customer not found in Lume AI</span>
                                </small>
                            </div>
                        </div>
                        
                        <!-- Customer Consent Information -->
                        <div id="consentInfo" style="display: none; background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%); padding: 12px 16px; border-radius: 10px; margin-top: 12px; border: 1px solid rgba(102, 126, 234, 0.2); box-shadow: 0 2px 8px rgba(102, 126, 234, 0.08);">
                            <h4 style="margin: 0 0 8px 0; color: #4c51bf; font-size: 13px; font-weight: 600; letter-spacing: -0.1px;">
                                üîí Customer Consent Preferences
                            </h4>
                            <div id="consentDetails" style="font-size: 12px;"></div>
                        </div>
                    </div>
                    
                    <!-- Product Category Section -->
                    <div class="form-section">
                        <h3 class="section-heading">üì¶ Product Selection</h3>
                        
                        <div class="form-group">
                            <label>Product Category *</label>
                            
                            <!-- Hidden input for form validation -->
                            <input type="hidden" id="productCategory" required>
                            
                            <!-- Custom Dropdown -->
                            <div class="custom-dropdown" id="productDropdown">
                                <div class="dropdown-trigger" onclick="toggleProductDropdown()">
                                    <span id="selectedProduct" class="selected-text placeholder">Select Product Type...</span>
                                    <svg class="dropdown-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                
                                <div class="dropdown-menu" id="productDropdownMenu">
                                    <!-- Credit Decisions -->
                                    <div class="dropdown-section">
                                        <div class="dropdown-section-label">üí∞ Credit Decisions</div>
                                        <div class="dropdown-option" onclick="selectProduct('LOAN', 'Loan Application', 'üí∞')">
                                            <span class="option-icon">üí∞</span>
                                            <div class="option-content">
                                                <div class="option-title">Loan Application</div>
                                                <div class="option-description">Personal, Home, Car, Education, Business</div>
                                            </div>
                                        </div>
                                        <div class="dropdown-option" onclick="selectProduct('CREDIT_CARD', 'Credit Card Application', 'üí≥')">
                                            <span class="option-icon">üí≥</span>
                                            <div class="option-content">
                                                <div class="option-title">Credit Card Application</div>
                                                <div class="option-description">New credit card with limit</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Fraud Detection -->
                                    <div class="dropdown-section">
                                        <div class="dropdown-section-label">üõ°Ô∏è Fraud Detection</div>
                                        <div class="dropdown-option" onclick="selectProduct('FRAUD_REVIEW', 'Transaction Review', 'üõ°Ô∏è')">
                                            <span class="option-icon">üõ°Ô∏è</span>
                                            <div class="option-content">
                                                <div class="option-title">Transaction Review</div>
                                                <div class="option-description">Verify suspicious activity</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Fields Container -->
                    <div id="dynamicFields"></div>

                    <!-- Customer Profile Section for Bias Detection -->
                    <div class="form-section">
                        <h3 class="section-heading">üìä Customer Profile (For AI Bias Detection)</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Age *</label>
                                <input type="number" id="age" placeholder="e.g., 68" min="18" max="100" required>
                            </div>
                            <div class="form-group">
                                <label>Location Type *</label>
                                <input type="hidden" id="locationType" required>
                                <div class="custom-dropdown" id="locationTypeDropdown">
                                    <div class="dropdown-trigger" onclick="toggleLocationTypeDropdown()">
                                        <span id="selectedLocationType" class="selected-text placeholder">Select Location Type...</span>
                                        <svg class="dropdown-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <div class="dropdown-menu" id="locationTypeDropdownMenu">
                                        <div class="dropdown-option" onclick="selectLocationType('urban', 'Urban', 'üèôÔ∏è')">
                                            <span class="option-icon">üèôÔ∏è</span>
                                            <div class="option-content">
                                                <div class="option-title">Urban</div>
                                                <div class="option-description">Metropolitan city</div>
                                            </div>
                                        </div>
                                        <div class="dropdown-option" onclick="selectLocationType('semi-urban', 'Semi-Urban', 'üèòÔ∏è')">
                                            <span class="option-icon">üèòÔ∏è</span>
                                            <div class="option-content">
                                                <div class="option-title">Semi-Urban</div>
                                                <div class="option-description">Town or suburb</div>
                                            </div>
                                        </div>
                                        <div class="dropdown-option" onclick="selectLocationType('rural', 'Rural', 'üåæ')">
                                            <span class="option-icon">üåæ</span>
                                            <div class="option-content">
                                                <div class="option-title">Rural</div>
                                                <div class="option-description">Village or countryside</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Digital Literacy *</label>
                            <input type="hidden" id="digitalLiteracy" required>
                            <div class="custom-dropdown" id="digitalLiteracyDropdown">
                                <div class="dropdown-trigger" onclick="toggleDigitalLiteracyDropdown()">
                                    <span id="selectedDigitalLiteracy" class="selected-text placeholder">Select Digital Literacy...</span>
                                    <svg class="dropdown-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="dropdown-menu" id="digitalLiteracyDropdownMenu">
                                    <div class="dropdown-option" onclick="selectDigitalLiteracy('high', 'High', 'üì±')">
                                        <span class="option-icon">üì±</span>
                                        <div class="option-content">
                                            <div class="option-title">High</div>
                                            <div class="option-description">Uses apps daily</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectDigitalLiteracy('medium', 'Medium', 'üíª')">
                                        <span class="option-icon">üíª</span>
                                        <div class="option-content">
                                            <div class="option-title">Medium</div>
                                            <div class="option-description">Basic usage</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectDigitalLiteracy('low', 'Low', 'üñ•Ô∏è')">
                                        <span class="option-icon">üñ•Ô∏è</span>
                                        <div class="option-content">
                                            <div class="option-title">Low</div>
                                            <div class="option-description">Minimal tech use</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">ü§ñ Analyze with AI</button>
                </form>

                <!-- AI Analysis Result -->
                <div id="resultPanel" class="result-panel">
                    <div class="result-title" id="resultTitle"></div>
                    
                    <div class="factors-list" id="factorsList"></div>
                    
                    <div id="biasWarning" class="bias-warning hidden">
                        <div class="bias-warning-title">
                            <span class="bias-warning-icon">‚ö†Ô∏è</span>
                            <span id="biasTitle"></span>
                        </div>
                        <div class="bias-groups" id="biasGroups"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-success" id="approveBtn" onclick="confirmDecision('APPROVED')">
                            ‚úÖ Approve Loan
                        </button>
                        <button class="btn btn-danger" id="denyBtn" onclick="confirmDecision('DENIED')">
                            ‚ùå Deny Loan
                        </button>
                    </div>
                </div>

                <!-- Success Message -->
                <div id="successMessage" class="success-message hidden"></div>

                <!-- Loading -->
                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Sending to customer app...</p>
                </div>
                
                </form>
            </div>
            </div>
            <!-- End Application Tab -->

            <!-- Fraud Detection Tab Content -->
            <div id="fraud-tab" class="tab-content">
            <div class="card">
                <!-- üö® FRAUD DETECTION SECTION -->
                <div>
                    <h2 style="color: #1e293b; font-size: 20px; font-weight: 700; margin-bottom: 8px;">
                        üö® Synthetic Identity Fraud Detection
                    </h2>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 24px; line-height: 1.6;">
                        Enter document details extracted from customer submissions for AI-powered fraud analysis.
                    </p>
                    
                    <!-- PAN Card Details -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #475569; font-size: 15px; font-weight: 600; margin-bottom: 12px;">ü™™ PAN Card Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>PAN Number</label>
                                <input type="text" id="fraudPanNumber" class="form-control" placeholder="e.g., ABCDE1234F">
                            </div>
                            <div class="form-group">
                                <label>Name on PAN</label>
                                <input type="text" id="fraudPanName" class="form-control" placeholder="e.g., Rajesh Kumar">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Address on PAN</label>
                            <input type="text" id="fraudPanAddress" class="form-control" placeholder="e.g., 123, MG Road, Bangalore - 560034">
                        </div>
                    </div>
                    
                    <!-- Aadhaar Card Details -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #475569; font-size: 15px; font-weight: 600; margin-bottom: 12px;">üÜî Aadhaar Card Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Aadhaar Number</label>
                                <input type="text" id="fraudAadhaarNumber" class="form-control" placeholder="e.g., 1234 5678 9012">
                            </div>
                            <div class="form-group">
                                <label>Name on Aadhaar</label>
                                <input type="text" id="fraudAadhaarName" class="form-control" placeholder="e.g., Rajesh Kumar">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Address on Aadhaar</label>
                            <input type="text" id="fraudAadhaarAddress" class="form-control" placeholder="e.g., 456, Park Street, Mumbai - 400053">
                        </div>
                    </div>
                    
                    <!-- Bank Statement Upload & Analysis -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #475569; font-size: 15px; font-weight: 600; margin-bottom: 12px;">üè¶ Bank Statement Upload</h3>
                        
                        <div class="form-group">
                            <label>Upload Bank Statement (Last 6 Months)</label>
                            <input type="file" id="statementUpload" accept=".pdf,image/*" class="form-control" onchange="handleStatementUpload(this)" style="padding: 10px;">
                            <small style="color: #64748b; font-size: 12px; display: block; margin-top: 6px;">
                                <span id="statementStatus">üìé Upload PDF or image of bank statement</span>
                            </small>
                        </div>
                    </div>
                    
                    <!-- Analyze Button -->
                    <div style="text-align: center; margin: 24px 0;">
                        <button id="analyzeButton" onclick="analyzeUploadedDocuments()" 
                                style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                       color: white; border: none; border-radius: 10px; 
                                       font-size: 15px; font-weight: 600; cursor: pointer; 
                                       box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); transition: all 0.3s;">
                            ü§ñ Analyze with LumeAI
                        </button>
                    </div>
                    
                    <!-- Document Display Section (After Analysis) -->
                    <div id="documentDisplay" style="display: none; margin-bottom: 24px;"></div>
                    
                    <!-- Analysis Results (shown after analysis) -->
                    <div id="fraudAnalysisResults" style="display: none; margin-top: 28px;"></div>
                </div>
            </div>
            </div>
            <!-- End Fraud Detection Tab -->

            <!-- Info Panel -->
            <div class="info-panel">
                <div class="card">
                    <h2>üìä Today's Statistics</h2>
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value" id="totalDecisions">0</div>
                            <div class="stat-label">Total Decisions</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="biasWarnings">0</div>
                            <div class="stat-label">Bias Warnings</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 16px;">
                    <h2>üìã Decision Criteria</h2>
                    <div id="criteriaContent" class="guidelines">
                        <p style="color: #94a3b8; font-size: 13px; text-align: center; padding: 16px 12px;">
                            Select a product category to view AI decision criteria
                        </p>
                    </div>
                </div>

                <div class="card" style="margin-top: 16px;">
                    <h2>üîç How LumeAI Works</h2>
                    <div class="guidelines">
                        <ul>
                            <li><strong>üí¨ Transparent:</strong> Shows all factors used in AI decisions</li>
                            <li><strong>‚öñÔ∏è Fair:</strong> Detects bias against age, location, digital literacy</li>
                            <li><strong>üîç Explainable:</strong> Clear reasons sent to customers instantly</li>
                            <li><strong>üîí Consent-Based:</strong> Respects customer privacy choices</li>
                            <li><strong>üì± Real-Time:</strong> Instant notifications on mobile app</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration - UPDATED WITH YOUR REAL VALUES ‚úÖ
        const firebaseConfig = {
            apiKey: "zzzzzzzz",
            authDomain: "xxxx-xxx-xxxxx.firebaseapp.com",
            databaseURL: "https://xxxx-xxxx-x-xxxx-rtdb.xxxxx.com",
            projectId: "xxxx-xxxx-xxxx",
            storageBucket: "xxxx-xxxx-xxxx.xxxxxxx.app",
            messagingSenderId: "112670824090",
            appId: "1:12345677:web:167f81f6ffd972b8fef123"
        };

        // Initialize Firebase
        let firebaseInitialized = false;
        let database = null;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            firebaseInitialized = true;
            console.log("‚úÖ Firebase initialized successfully");
        } catch (error) {
            console.warn("‚ö†Ô∏è Firebase not configured. Running in demo mode.", error);
        }

        // Application state
        let currentApplication = null;
        let currentDecisionId = null;

        // Tab Switching Function
        function switchTab(tabName) {
            // Hide all tab contents
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab and activate button
            if (tabName === 'application') {
                document.getElementById('application-tab').classList.add('active');
                event.target.classList.add('active');
            } else if (tabName === 'fraud') {
                document.getElementById('fraud-tab').classList.add('active');
                event.target.classList.add('active');
            }
        }

        // Custom Dropdown Functions
        function toggleProductDropdown() {
            const trigger = document.querySelector('.dropdown-trigger');
            const menu = document.getElementById('productDropdownMenu');
            const isOpen = menu.classList.contains('show');
            
            if (isOpen) {
                closeProductDropdown();
            } else {
                trigger.classList.add('active');
                menu.classList.add('show');
                
                // Add click outside listener
                setTimeout(() => {
                    document.addEventListener('click', handleClickOutside);
                }, 10);
            }
        }

        function closeProductDropdown() {
            const trigger = document.querySelector('.dropdown-trigger');
            const menu = document.getElementById('productDropdownMenu');
            
            trigger.classList.remove('active');
            menu.classList.remove('show');
            document.removeEventListener('click', handleClickOutside);
        }

        function handleClickOutside(event) {
            const dropdown = document.getElementById('productDropdown');
            if (!dropdown.contains(event.target)) {
                closeProductDropdown();
            }
        }

        function selectProduct(value, label, icon) {
            // Update hidden input
            document.getElementById('productCategory').value = value;
            
            // Update display
            const selectedText = document.getElementById('selectedProduct');
            selectedText.textContent = `${icon} ${label}`;
            selectedText.classList.remove('placeholder');
            
            // Close dropdown
            closeProductDropdown();
            
            // Trigger form update
            updateProductFields();
        }

        // Loan Type Dropdown Functions
        function toggleLoanTypeDropdown() {
            const dropdown = document.getElementById('loanTypeDropdown');
            if (!dropdown) return;
            
            const trigger = dropdown.querySelector('.dropdown-trigger');
            const menu = document.getElementById('loanTypeDropdownMenu');
            const isOpen = menu.classList.contains('show');
            
            if (isOpen) {
                closeLoanTypeDropdown();
            } else {
                trigger.classList.add('active');
                menu.classList.add('show');
                
                // Add click outside listener
                setTimeout(() => {
                    document.addEventListener('click', handleLoanTypeClickOutside);
                }, 10);
            }
        }

        function closeLoanTypeDropdown() {
            const dropdown = document.getElementById('loanTypeDropdown');
            if (!dropdown) return;
            
            const trigger = dropdown.querySelector('.dropdown-trigger');
            const menu = document.getElementById('loanTypeDropdownMenu');
            
            trigger.classList.remove('active');
            menu.classList.remove('show');
            document.removeEventListener('click', handleLoanTypeClickOutside);
        }

        function handleLoanTypeClickOutside(event) {
            const dropdown = document.getElementById('loanTypeDropdown');
            if (dropdown && !dropdown.contains(event.target)) {
                closeLoanTypeDropdown();
            }
        }

        function selectLoanType(value, label, icon) {
            // Update hidden input
            document.getElementById('loanType').value = value;
            
            // Update display
            const selectedText = document.getElementById('selectedLoanType');
            if (selectedText) {
                selectedText.textContent = `${icon} ${label}`;
                selectedText.classList.remove('placeholder');
            }
            
            // Close dropdown
            closeLoanTypeDropdown();
        }

        // Digital Footprint Dropdown Functions
        function toggleDigitalFootprintDropdown() {
            const menu = document.getElementById('digitalFootprintDropdownMenu');
            if (menu) menu.classList.toggle('show');
        }

        function closeDigitalFootprintDropdown() {
            const menu = document.getElementById('digitalFootprintDropdownMenu');
            if (menu) menu.classList.remove('show');
        }

        function selectDigitalFootprint(value, label, icon) {
            document.getElementById('digitalFootprint').value = value;
            const selectedText = document.getElementById('selectedDigitalFootprint');
            if (selectedText) {
                selectedText.textContent = `${icon} ${label}`;
                selectedText.classList.remove('placeholder');
            }
            closeDigitalFootprintDropdown();
        }

        // Transaction Location Dropdown Functions
        function toggleTransactionLocationDropdown() {
            const menu = document.getElementById('transactionLocationDropdownMenu');
            if (menu) menu.classList.toggle('show');
        }

        function closeTransactionLocationDropdown() {
            const menu = document.getElementById('transactionLocationDropdownMenu');
            if (menu) menu.classList.remove('show');
        }

        function selectTransactionLocation(value, label, icon) {
            document.getElementById('transactionLocation').value = value;
            const selectedText = document.getElementById('selectedTransactionLocation');
            if (selectedText) {
                selectedText.textContent = `${icon} ${label}`;
                selectedText.classList.remove('placeholder');
            }
            closeTransactionLocationDropdown();
        }

        // Merchant Category Dropdown Functions
        function toggleMerchantCategoryDropdown() {
            const menu = document.getElementById('merchantCategoryDropdownMenu');
            if (menu) menu.classList.toggle('show');
        }

        function closeMerchantCategoryDropdown() {
            const menu = document.getElementById('merchantCategoryDropdownMenu');
            if (menu) menu.classList.remove('show');
        }

        function selectMerchantCategory(value, label, icon) {
            document.getElementById('merchantCategory').value = value;
            const selectedText = document.getElementById('selectedMerchantCategory');
            if (selectedText) {
                selectedText.textContent = `${icon} ${label}`;
                selectedText.classList.remove('placeholder');
            }
            closeMerchantCategoryDropdown();
        }

        // Previous Fraud Dropdown Functions
        function togglePreviousFraudDropdown() {
            const menu = document.getElementById('previousFraudDropdownMenu');
            if (menu) menu.classList.toggle('show');
        }

        function closePreviousFraudDropdown() {
            const menu = document.getElementById('previousFraudDropdownMenu');
            if (menu) menu.classList.remove('show');
        }

        function selectPreviousFraud(value, label, icon) {
            document.getElementById('previousFraud').value = value;
            const selectedText = document.getElementById('selectedPreviousFraud');
            if (selectedText) {
                selectedText.textContent = `${icon} ${label}`;
                selectedText.classList.remove('placeholder');
            }
            closePreviousFraudDropdown();
        }

        // Current Account Type Dropdown Functions
        function toggleCurrentAccountTypeDropdown() {
            const menu = document.getElementById('currentAccountTypeDropdownMenu');
            if (menu) menu.classList.toggle('show');
        }

        function closeCurrentAccountTypeDropdown() {
            const menu = document.getElementById('currentAccountTypeDropdownMenu');
            if (menu) menu.classList.remove('show');
        }

        function selectCurrentAccountType(value, label, icon) {
            document.getElementById('currentAccountType').value = value;
            const selectedText = document.getElementById('selectedCurrentAccountType');
            if (selectedText) {
                selectedText.textContent = `${icon} ${label}`;
                selectedText.classList.remove('placeholder');
            }
            closeCurrentAccountTypeDropdown();
        }

        // Digital Banking Usage Dropdown Functions
        function toggleDigitalBankingUsageDropdown() {
            const menu = document.getElementById('digitalBankingUsageDropdownMenu');
            if (menu) menu.classList.toggle('show');
        }

        function closeDigitalBankingUsageDropdown() {
            const menu = document.getElementById('digitalBankingUsageDropdownMenu');
            if (menu) menu.classList.remove('show');
        }

        function selectDigitalBankingUsage(value, label, icon) {
            document.getElementById('digitalBankingUsage').value = value;
            const selectedText = document.getElementById('selectedDigitalBankingUsage');
            if (selectedText) {
                selectedText.textContent = `${icon} ${label}`;
                selectedText.classList.remove('placeholder');
            }
            closeDigitalBankingUsageDropdown();
        }

        // Location Type Dropdown Functions (Static Form)
        function toggleLocationTypeDropdown() {
            const menu = document.getElementById('locationTypeDropdownMenu');
            if (menu) menu.classList.toggle('show');
        }

        function closeLocationTypeDropdown() {
            const menu = document.getElementById('locationTypeDropdownMenu');
            if (menu) menu.classList.remove('show');
        }

        function selectLocationType(value, label, icon) {
            document.getElementById('locationType').value = value;
            const selectedText = document.getElementById('selectedLocationType');
            if (selectedText) {
                selectedText.textContent = `${icon} ${label}`;
                selectedText.classList.remove('placeholder');
            }
            closeLocationTypeDropdown();
        }

        // Digital Literacy Dropdown Functions (Static Form)
        function toggleDigitalLiteracyDropdown() {
            const menu = document.getElementById('digitalLiteracyDropdownMenu');
            if (menu) menu.classList.toggle('show');
        }

        function closeDigitalLiteracyDropdown() {
            const menu = document.getElementById('digitalLiteracyDropdownMenu');
            if (menu) menu.classList.remove('show');
        }

        function selectDigitalLiteracy(value, label, icon) {
            document.getElementById('digitalLiteracy').value = value;
            const selectedText = document.getElementById('selectedDigitalLiteracy');
            if (selectedText) {
                selectedText.textContent = `${icon} ${label}`;
                selectedText.classList.remove('placeholder');
            }
            closeDigitalLiteracyDropdown();
        }

        // Dynamic form fields configuration
        function updateProductFields() {
            const productCategory = document.getElementById('productCategory').value;
            const dynamicFields = document.getElementById('dynamicFields');
            
            if (!productCategory) {
                dynamicFields.innerHTML = '';
                return;
            }

            // Dynamic heading based on product type
            let headingText = 'üìù Product-Specific Details';
            let headingIcon = 'üìù';
            if (productCategory === 'LOAN') {
                headingText = 'üí∞ Loan Application Details';
                headingIcon = 'üí∞';
            } else if (productCategory === 'CREDIT_CARD') {
                headingText = 'üí≥ Credit Card Details';
                headingIcon = 'üí≥';
            } else if (productCategory === 'FRAUD_REVIEW') {
                headingText = 'üõ°Ô∏è Transaction Details';
                headingIcon = 'üõ°Ô∏è';
            } else if (productCategory === 'PERSONALIZED_CAR_LOAN') {
                headingText = 'üöó Car Loan Offer';
                headingIcon = 'üöó';
            } else if (productCategory === 'PERSONALIZED_HOME_LOAN') {
                headingText = 'üè† Home Loan Offer';
                headingIcon = 'üè†';
            } else if (productCategory === 'PERSONALIZED_CREDIT_CARD') {
                headingText = 'üíé Credit Card Offer';
                headingIcon = 'üíé';
            } else if (productCategory === 'PERSONALIZED_INVESTMENT') {
                headingText = 'üìà Investment Plan';
                headingIcon = 'üìà';
            } else if (productCategory === 'PERSONALIZED_INSURANCE') {
                headingText = 'üõ°Ô∏è Insurance Offer';
                headingIcon = 'üõ°Ô∏è';
            }

            let fieldsHTML = '<div class="form-section">';
            fieldsHTML += `<h3 class="section-heading">${headingText}</h3>`;

            if (productCategory === 'LOAN') {
                fieldsHTML += `
                    <div class="form-row">
                        <div class="form-group">
                            <label>Loan Type *</label>
                            <input type="hidden" id="loanType" required>
                            <div class="custom-dropdown" id="loanTypeDropdown">
                                <div class="dropdown-trigger" onclick="toggleLoanTypeDropdown()">
                                    <span id="selectedLoanType" class="selected-text placeholder">Select Loan Type...</span>
                                    <svg class="dropdown-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="dropdown-menu" id="loanTypeDropdownMenu">
                                    <div class="dropdown-option" onclick="selectLoanType('PERSONAL_LOAN', 'Personal Loan', 'üí∞')">
                                        <span class="option-icon">üí∞</span>
                                        <div class="option-content">
                                            <div class="option-title">Personal Loan</div>
                                            <div class="option-description">For personal expenses</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectLoanType('HOME_LOAN', 'Home Loan', 'üè†')">
                                        <span class="option-icon">üè†</span>
                                        <div class="option-content">
                                            <div class="option-title">Home Loan</div>
                                            <div class="option-description">Property purchase or construction</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectLoanType('CAR_LOAN', 'Car Loan', 'üöó')">
                                        <span class="option-icon">üöó</span>
                                        <div class="option-content">
                                            <div class="option-title">Car Loan</div>
                                            <div class="option-description">Vehicle financing</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectLoanType('EDUCATION_LOAN', 'Education Loan', 'üéì')">
                                        <span class="option-icon">üéì</span>
                                        <div class="option-content">
                                            <div class="option-title">Education Loan</div>
                                            <div class="option-description">Higher education funding</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectLoanType('BUSINESS_LOAN', 'Business Loan', 'üíº')">
                                        <span class="option-icon">üíº</span>
                                        <div class="option-content">
                                            <div class="option-title">Business Loan</div>
                                            <div class="option-description">Business expansion or capital</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Loan Amount (‚Çπ) *</label>
                            <input type="number" id="loanAmount" placeholder="e.g., 500000" min="10000" step="10000" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Credit Score *</label>
                            <input type="number" id="creditScore" placeholder="300-850" min="300" max="850" required>
                        </div>
                        <div class="form-group">
                            <label>Monthly Income (‚Çπ) *</label>
                            <input type="number" id="monthlyIncome" placeholder="e.g., 25000" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Monthly Deductions (‚Çπ) *</label>
                            <input type="number" id="monthlyDebt" placeholder="e.g., EMIs, rent, other loans - 15000" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Employment Tenure (Months) *</label>
                            <input type="number" id="employmentMonths" placeholder="e.g., 24" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Digital Footprint *</label>
                        <input type="hidden" id="digitalFootprint" required>
                        <div class="custom-dropdown" id="digitalFootprintDropdown">
                            <div class="dropdown-trigger" onclick="toggleDigitalFootprintDropdown()">
                                <span id="selectedDigitalFootprint" class="selected-text placeholder">Select Digital Footprint...</span>
                                <svg class="dropdown-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="dropdown-menu" id="digitalFootprintDropdownMenu">
                                <div class="dropdown-option" onclick="selectDigitalFootprint('high', 'High', 'üåê')">
                                    <span class="option-icon">üåê</span>
                                    <div class="option-content">
                                        <div class="option-title">High</div>
                                        <div class="option-description">Active online presence</div>
                                    </div>
                                </div>
                                <div class="dropdown-option" onclick="selectDigitalFootprint('medium', 'Medium', 'üì±')">
                                    <span class="option-icon">üì±</span>
                                    <div class="option-content">
                                        <div class="option-title">Medium</div>
                                        <div class="option-description">Some online activity</div>
                                    </div>
                                </div>
                                <div class="dropdown-option" onclick="selectDigitalFootprint('low', 'Low', 'üìµ')">
                                    <span class="option-icon">üìµ</span>
                                    <div class="option-content">
                                        <div class="option-title">Low</div>
                                        <div class="option-description">Minimal online presence</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (productCategory === 'CREDIT_CARD') {
                fieldsHTML += `
                    <div class="form-row">
                        <div class="form-group">
                            <label>Desired Credit Limit (‚Çπ) *</label>
                            <input type="number" id="creditLimit" placeholder="e.g., 100000" min="10000" step="10000" required>
                        </div>
                        <div class="form-group">
                            <label>Credit Score *</label>
                            <input type="number" id="creditScore" placeholder="300-850" min="300" max="850" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Monthly Income (‚Çπ) *</label>
                            <input type="number" id="monthlyIncome" placeholder="e.g., 25000" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Existing Credit Cards *</label>
                            <input type="number" id="existingCards" placeholder="e.g., 2" min="0" max="10" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Employment Tenure (Months) *</label>
                        <input type="number" id="employmentMonths" placeholder="e.g., 24" min="0" required>
                    </div>
                `;
            } else if (productCategory === 'FRAUD_REVIEW') {
                fieldsHTML += `
                    <div class="form-row">
                        <div class="form-group">
                            <label>Transaction Amount (‚Çπ) *</label>
                            <input type="number" id="transactionAmount" placeholder="e.g., 50000" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Transaction Location *</label>
                            <input type="hidden" id="transactionLocation" required>
                            <div class="custom-dropdown" id="transactionLocationDropdown">
                                <div class="dropdown-trigger" onclick="toggleTransactionLocationDropdown()">
                                    <span id="selectedTransactionLocation" class="selected-text placeholder">Select Location...</span>
                                    <svg class="dropdown-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="dropdown-menu" id="transactionLocationDropdownMenu">
                                    <div class="dropdown-option" onclick="selectTransactionLocation('local', 'Local', 'üè†')">
                                        <span class="option-icon">üè†</span>
                                        <div class="option-content">
                                            <div class="option-title">Local</div>
                                            <div class="option-description">Same City</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectTransactionLocation('domestic', 'Domestic', 'üáÆüá≥')">
                                        <span class="option-icon">üáÆüá≥</span>
                                        <div class="option-content">
                                            <div class="option-title">Domestic</div>
                                            <div class="option-description">Different City</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectTransactionLocation('international', 'International', 'üåç')">
                                        <span class="option-icon">üåç</span>
                                        <div class="option-content">
                                            <div class="option-title">International</div>
                                            <div class="option-description">Cross-border transaction</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Merchant Category *</label>
                            <input type="hidden" id="merchantCategory" required>
                            <div class="custom-dropdown" id="merchantCategoryDropdown">
                                <div class="dropdown-trigger" onclick="toggleMerchantCategoryDropdown()">
                                    <span id="selectedMerchantCategory" class="selected-text placeholder">Select Category...</span>
                                    <svg class="dropdown-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="dropdown-menu" id="merchantCategoryDropdownMenu">
                                    <div class="dropdown-option" onclick="selectMerchantCategory('retail', 'Retail/Shopping', 'üõçÔ∏è')">
                                        <span class="option-icon">üõçÔ∏è</span>
                                        <div class="option-content">
                                            <div class="option-title">Retail/Shopping</div>
                                            <div class="option-description">Physical store purchase</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectMerchantCategory('online', 'Online Purchase', 'üíª')">
                                        <span class="option-icon">üíª</span>
                                        <div class="option-content">
                                            <div class="option-title">Online Purchase</div>
                                            <div class="option-description">E-commerce transaction</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectMerchantCategory('atm', 'ATM Withdrawal', 'üèß')">
                                        <span class="option-icon">üèß</span>
                                        <div class="option-content">
                                            <div class="option-title">ATM Withdrawal</div>
                                            <div class="option-description">Cash withdrawal</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectMerchantCategory('transfer', 'Fund Transfer', 'üí∏')">
                                        <span class="option-icon">üí∏</span>
                                        <div class="option-content">
                                            <div class="option-title">Fund Transfer</div>
                                            <div class="option-description">Bank transfer or UPI</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Account Age (Months) *</label>
                            <input type="number" id="accountAge" placeholder="e.g., 24" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Average Monthly Transactions *</label>
                            <input type="number" id="avgTransactions" placeholder="e.g., 15" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Previous Fraud Cases *</label>
                            <input type="hidden" id="previousFraud" required>
                            <div class="custom-dropdown" id="previousFraudDropdown">
                                <div class="dropdown-trigger" onclick="togglePreviousFraudDropdown()">
                                    <span id="selectedPreviousFraud" class="selected-text placeholder">Select History...</span>
                                    <svg class="dropdown-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="dropdown-menu" id="previousFraudDropdownMenu">
                                    <div class="dropdown-option" onclick="selectPreviousFraud('none', 'None', '‚úÖ')">
                                        <span class="option-icon">‚úÖ</span>
                                        <div class="option-content">
                                            <div class="option-title">None</div>
                                            <div class="option-description">No fraud history</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectPreviousFraud('suspected', 'Suspected Once', '‚ö†Ô∏è')">
                                        <span class="option-icon">‚ö†Ô∏è</span>
                                        <div class="option-content">
                                            <div class="option-title">Suspected Once</div>
                                            <div class="option-description">One suspicious incident</div>
                                        </div>
                                    </div>
                                    <div class="dropdown-option" onclick="selectPreviousFraud('confirmed', 'Confirmed Before', 'üö®')">
                                        <span class="option-icon">üö®</span>
                                        <div class="option-content">
                                            <div class="option-title">Confirmed Before</div>
                                            <div class="option-description">Confirmed fraud case</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (productCategory === 'PERSONALIZED_CAR_LOAN' || productCategory === 'PERSONALIZED_HOME_LOAN' || productCategory === 'PERSONALIZED_CREDIT_CARD' || productCategory === 'PERSONALIZED_INVESTMENT' || productCategory === 'PERSONALIZED_INSURANCE') {
                // Common fields for AI-personalized offers
                fieldsHTML += `
                    <div class="info-banner" style="background: linear-gradient(135deg, #EFF6FF 0%, #E0E7FF 100%); padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                        <p style="margin: 0; color: #1e40af; font-weight: 600; font-size: 14px;">
                            ü§ñ <strong>AI Transparency:</strong> This offer is personalized based on your credit profile, income stability, and payment history.
                        </p>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Credit Score *</label>
                            <input type="number" id="creditScore" placeholder="300-850" min="300" max="850" required>
                        </div>
                        <div class="form-group">
                            <label>Monthly Income (‚Çπ) *</label>
                            <input type="number" id="monthlyIncome" placeholder="e.g., 45000" min="0" required>
                        </div>
                    </div>
                `;
                
                if (productCategory === 'PERSONALIZED_CAR_LOAN') {
                    fieldsHTML += `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Desired Loan Amount (‚Çπ) *</label>
                                <input type="number" id="loanAmount" placeholder="e.g., 800000" min="100000" step="50000" required>
                            </div>
                            <div class="form-group">
                                <label>Employment Tenure (Months) *</label>
                                <input type="number" id="employmentMonths" placeholder="e.g., 24" min="0" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Monthly Deductions (‚Çπ) *</label>
                                <input type="number" id="monthlyDebt" placeholder="EMIs, rent - e.g., 12000" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Existing Loan Count *</label>
                                <input type="number" id="existingLoans" placeholder="e.g., 1" min="0" max="5" required>
                            </div>
                        </div>
                    `;
                } else if (productCategory === 'PERSONALIZED_HOME_LOAN') {
                    fieldsHTML += `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Desired Loan Amount (‚Çπ) *</label>
                                <input type="number" id="loanAmount" placeholder="e.g., 3000000" min="500000" step="100000" required>
                            </div>
                            <div class="form-group">
                                <label>Employment Tenure (Months) *</label>
                                <input type="number" id="employmentMonths" placeholder="e.g., 36" min="0" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Monthly Deductions (‚Çπ) *</label>
                                <input type="number" id="monthlyDebt" placeholder="EMIs, rent - e.g., 15000" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Co-Applicant Income (‚Çπ) *</label>
                                <input type="number" id="coApplicantIncome" placeholder="0 if none" min="0" required>
                            </div>
                        </div>
                    `;
                } else if (productCategory === 'PERSONALIZED_CREDIT_CARD') {
                    fieldsHTML += `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Desired Credit Limit (‚Çπ) *</label>
                                <input type="number" id="creditLimit" placeholder="e.g., 150000" min="25000" step="25000" required>
                            </div>
                            <div class="form-group">
                                <label>Existing Credit Cards *</label>
                                <input type="number" id="existingCards" placeholder="e.g., 1" min="0" max="5" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Employment Tenure (Months) *</label>
                            <input type="number" id="employmentMonths" placeholder="e.g., 18" min="0" required>
                        </div>
                    `;
                } else if (productCategory === 'PERSONALIZED_INVESTMENT') {
                    fieldsHTML += `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Investment Amount (‚Çπ/month) *</label>
                                <input type="number" id="investmentAmount" placeholder="e.g., 5000" min="500" step="500" required>
                            </div>
                            <div class="form-group">
                                <label>Investment Horizon (Years) *</label>
                                <input type="number" id="investmentHorizon" placeholder="e.g., 10" min="1" max="30" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Risk Appetite *</label>
                            <select id="riskAppetite" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                <option value="">Select risk level...</option>
                                <option value="low">Low (Conservative)</option>
                                <option value="medium">Medium (Balanced)</option>
                                <option value="high">High (Aggressive)</option>
                            </select>
                        </div>
                    `;
                } else if (productCategory === 'PERSONALIZED_INSURANCE') {
                    fieldsHTML += `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Desired Coverage (‚Çπ) *</label>
                                <input type="number" id="coverageAmount" placeholder="e.g., 5000000" min="100000" step="100000" required>
                            </div>
                            <div class="form-group">
                                <label>Number of Dependents *</label>
                                <input type="number" id="dependents" placeholder="e.g., 3" min="0" max="10" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Health Status *</label>
                            <select id="healthStatus" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                <option value="">Select health status...</option>
                                <option value="excellent">Excellent</option>
                                <option value="good">Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                    `;
                }
            }

            fieldsHTML += '</div>';
            dynamicFields.innerHTML = fieldsHTML;

            // Update criteria panel
            updateCriteriaPanel(productCategory);
        }

        function updateCriteriaPanel(productCategory) {
            const criteriaContent = document.getElementById('criteriaContent');
            
            // Dynamic heading based on product type
            let heading = 'Required for Approval:';
            if (productCategory === 'FRAUD_REVIEW') {
                heading = 'Verification Criteria:';
            } else if (productCategory.startsWith('PERSONALIZED_')) {
                heading = 'Why We Recommend This:';
            }
            
            let criteriaHTML = `<h3>${heading}</h3><ul>`;

            if (productCategory === 'LOAN') {
                criteriaHTML += `
                    <li>Credit Score: ‚â• 650</li>
                    <li>Monthly Income: ‚â• ‚Çπ30,000</li>
                    <li>Debt-to-Income: ‚â§ 40%</li>
                    <li>Employment: ‚â• 12 months</li>
                    <li>Digital Footprint: Medium+</li>
                `;
            } else if (productCategory === 'CREDIT_CARD') {
                criteriaHTML += `
                    <li>Credit Score: ‚â• 700</li>
                    <li>Monthly Income: ‚â• ‚Çπ40,000</li>
                    <li>Existing Cards: ‚â§ 3</li>
                    <li>Employment: ‚â• 18 months</li>
                `;
            } else if (productCategory === 'FRAUD_REVIEW') {
                criteriaHTML += `
                    <li>Transaction Amount: ‚â§ ‚Çπ50,000</li>
                    <li>Location: Local/Domestic</li>
                    <li>Account Age: ‚â• 12 months</li>
                    <li>Fraud History: None</li>
                    <li>Transaction Pattern: Regular</li>
                `;
            } else if (productCategory === 'PERSONALIZED_CAR_LOAN') {
                criteriaHTML += `
                    <li>Credit Score: ‚â• 700</li>
                    <li>Monthly Income: ‚â• ‚Çπ40,000</li>
                    <li>Debt-to-Income: ‚â§ 35%</li>
                    <li>Employment: ‚â• 18 months</li>
                    <li>Loan Amount: ‚â§ ‚Çπ15 Lakhs</li>
                `;
            } else if (productCategory === 'PERSONALIZED_HOME_LOAN') {
                criteriaHTML += `
                    <li>Credit Score: ‚â• 750</li>
                    <li>Monthly Income: ‚â• ‚Çπ50,000</li>
                    <li>Debt-to-Income: ‚â§ 40%</li>
                    <li>Employment: ‚â• 24 months</li>
                    <li>Age: < 50 years</li>
                `;
            } else if (productCategory === 'PERSONALIZED_CREDIT_CARD') {
                criteriaHTML += `
                    <li>Credit Score: ‚â• 680</li>
                    <li>Monthly Income: ‚â• ‚Çπ30,000</li>
                    <li>Existing Cards: ‚â§ 2</li>
                    <li>Employment: ‚â• 12 months</li>
                    <li>Payment History: Good</li>
                `;
            } else if (productCategory === 'PERSONALIZED_INVESTMENT') {
                criteriaHTML += `
                    <li>Credit Score: ‚â• 650</li>
                    <li>Monthly Income: ‚â• ‚Çπ25,000</li>
                    <li>Investment Amount: ‚â• ‚Çπ500/month</li>
                    <li>Investment Horizon: ‚â• 3 years</li>
                    <li>Financial Discipline: Good</li>
                `;
            } else if (productCategory === 'PERSONALIZED_INSURANCE') {
                criteriaHTML += `
                    <li>Age: 18-60 years</li>
                    <li>Monthly Income: ‚â• ‚Çπ20,000</li>
                    <li>Health Status: Good or better</li>
                    <li>Coverage: Based on income √ó 10-15</li>
                    <li>Dependents: Considered in calculation</li>
                `;
            }

            criteriaHTML += '</ul>';
            criteriaContent.innerHTML = criteriaHTML;
            criteriaContent.className = 'guidelines';
        }

        // Form submission
        document.getElementById('loanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            analyzeApplication();
        });

        function analyzeApplication() {
            // Get common data
            const customerId = document.getElementById('customerId').value.trim();
            const customerName = document.getElementById('customerName').value;
            const productCategory = document.getElementById('productCategory').value;
            const age = parseInt(document.getElementById('age').value);
            const locationType = document.getElementById('locationType').value;
            const digitalLiteracy = document.getElementById('digitalLiteracy').value;
            const bankName = document.getElementById('bankSelect').value;

            let factors = [];
            let productData = { productCategory };

            // Analyze based on product type
            if (productCategory === 'LOAN') {
                const loanType = document.getElementById('loanType').value;
                const loanAmount = parseFloat(document.getElementById('loanAmount').value);
                const creditScore = parseInt(document.getElementById('creditScore').value);
                const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value);
                const monthlyDebt = parseFloat(document.getElementById('monthlyDebt').value);
                const employmentMonths = parseInt(document.getElementById('employmentMonths').value);
                const digitalFootprint = document.getElementById('digitalFootprint').value;
                const debtRatio = (monthlyDebt / monthlyIncome).toFixed(2);

                productData = { ...productData, loanType, loanAmount, creditScore, monthlyIncome, monthlyDebt, employmentMonths, digitalFootprint, debtRatio: parseFloat(debtRatio) };

                factors = [
                    { name: "Credit Score", value: creditScore, required: 650, passed: creditScore >= 650 },
                    { name: "Monthly Income", value: `‚Çπ${monthlyIncome.toLocaleString()}`, required: "‚Çπ30,000", passed: monthlyIncome >= 30000 },
                    { name: "Debt-to-Income Ratio", value: `${(debtRatio * 100).toFixed(0)}%`, required: "‚â§ 40%", passed: debtRatio <= 0.40 },
                    { name: "Employment Tenure", value: `${employmentMonths} months`, required: "12 months", passed: employmentMonths >= 12 },
                    { name: "Digital Footprint", value: digitalFootprint.charAt(0).toUpperCase() + digitalFootprint.slice(1), required: "Medium+", passed: digitalFootprint !== "low" }
                ];

            } else if (productCategory === 'CREDIT_CARD') {
                const creditLimit = parseFloat(document.getElementById('creditLimit').value);
                const creditScore = parseInt(document.getElementById('creditScore').value);
                const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value);
                const existingCards = parseInt(document.getElementById('existingCards').value);
                const employmentMonths = parseInt(document.getElementById('employmentMonths').value);

                productData = { ...productData, creditLimit, creditScore, monthlyIncome, existingCards, employmentMonths };

                factors = [
                    { name: "Credit Score", value: creditScore, required: 700, passed: creditScore >= 700 },
                    { name: "Monthly Income", value: `‚Çπ${monthlyIncome.toLocaleString()}`, required: "‚Çπ40,000", passed: monthlyIncome >= 40000 },
                    { name: "Existing Cards", value: existingCards, required: "‚â§ 3", passed: existingCards <= 3 },
                    { name: "Employment Tenure", value: `${employmentMonths} months`, required: "18 months", passed: employmentMonths >= 18 }
                ];

            } else if (productCategory === 'FRAUD_REVIEW') {
                const transactionAmount = parseFloat(document.getElementById('transactionAmount').value);
                const transactionLocation = document.getElementById('transactionLocation').value;
                const merchantCategory = document.getElementById('merchantCategory').value;
                const accountAge = parseInt(document.getElementById('accountAge').value);
                const avgTransactions = parseInt(document.getElementById('avgTransactions').value);
                const previousFraud = document.getElementById('previousFraud').value;

                productData = { ...productData, transactionAmount, transactionLocation, merchantCategory, accountAge, avgTransactions, previousFraud };

                const isLowRisk = transactionAmount <= 50000 && transactionLocation === 'local' && previousFraud === 'none' && accountAge >= 12;

                factors = [
                    { name: "Transaction Amount", value: `‚Çπ${transactionAmount.toLocaleString()}`, required: "‚â§ ‚Çπ50,000", passed: transactionAmount <= 50000 },
                    { name: "Transaction Location", value: transactionLocation.charAt(0).toUpperCase() + transactionLocation.slice(1), required: "Local/Domestic", passed: transactionLocation !== 'international' },
                    { name: "Account Age", value: `${accountAge} months`, required: "‚â• 12 months", passed: accountAge >= 12 },
                    { name: "Previous Fraud History", value: previousFraud === 'none' ? 'None' : 'Yes', required: "None", passed: previousFraud === 'none' },
                    { name: "Transaction Pattern", value: avgTransactions >= 10 ? 'Regular' : 'Irregular', required: "Regular", passed: avgTransactions >= 10 }
                ];

            } else if (productCategory === 'PERSONALIZED_CAR_LOAN') {
                const loanAmount = parseFloat(document.getElementById('loanAmount').value);
                const creditScore = parseInt(document.getElementById('creditScore').value);
                const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value);
                const monthlyDebt = parseFloat(document.getElementById('monthlyDebt').value);
                const employmentMonths = parseInt(document.getElementById('employmentMonths').value);
                const existingLoans = parseInt(document.getElementById('existingLoans').value);
                const debtRatio = (monthlyDebt / monthlyIncome).toFixed(2);

                productData = { ...productData, loanAmount, creditScore, monthlyIncome, monthlyDebt, employmentMonths, existingLoans, debtRatio: parseFloat(debtRatio) };

                factors = [
                    { name: "Credit Score", value: creditScore, required: 700, passed: creditScore >= 700 },
                    { name: "Monthly Income", value: `‚Çπ${monthlyIncome.toLocaleString()}`, required: "‚Çπ40,000", passed: monthlyIncome >= 40000 },
                    { name: "Debt-to-Income Ratio", value: `${(debtRatio * 100).toFixed(0)}%`, required: "‚â§ 35%", passed: debtRatio <= 0.35 },
                    { name: "Employment Tenure", value: `${employmentMonths} months`, required: "18 months", passed: employmentMonths >= 18 },
                    { name: "Loan Amount", value: `‚Çπ${loanAmount.toLocaleString()}`, required: "‚â§ ‚Çπ15 Lakhs", passed: loanAmount <= 1500000 }
                ];

            } else if (productCategory === 'PERSONALIZED_HOME_LOAN') {
                const loanAmount = parseFloat(document.getElementById('loanAmount').value);
                const creditScore = parseInt(document.getElementById('creditScore').value);
                const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value);
                const monthlyDebt = parseFloat(document.getElementById('monthlyDebt').value);
                const employmentMonths = parseInt(document.getElementById('employmentMonths').value);
                const coApplicantIncome = parseFloat(document.getElementById('coApplicantIncome').value);
                const totalIncome = monthlyIncome + coApplicantIncome;
                const debtRatio = (monthlyDebt / totalIncome).toFixed(2);

                productData = { ...productData, loanAmount, creditScore, monthlyIncome, monthlyDebt, employmentMonths, coApplicantIncome, totalIncome, debtRatio: parseFloat(debtRatio) };

                factors = [
                    { name: "Credit Score", value: creditScore, required: 750, passed: creditScore >= 750 },
                    { name: "Combined Income", value: `‚Çπ${totalIncome.toLocaleString()}`, required: "‚Çπ50,000", passed: totalIncome >= 50000 },
                    { name: "Debt-to-Income Ratio", value: `${(debtRatio * 100).toFixed(0)}%`, required: "‚â§ 40%", passed: debtRatio <= 0.40 },
                    { name: "Employment Tenure", value: `${employmentMonths} months`, required: "24 months", passed: employmentMonths >= 24 },
                    { name: "Age", value: `${age} years`, required: "< 50", passed: age < 50 }
                ];

            } else if (productCategory === 'PERSONALIZED_CREDIT_CARD') {
                const creditLimit = parseFloat(document.getElementById('creditLimit').value);
                const creditScore = parseInt(document.getElementById('creditScore').value);
                const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value);
                const existingCards = parseInt(document.getElementById('existingCards').value);
                const employmentMonths = parseInt(document.getElementById('employmentMonths').value);

                productData = { ...productData, creditLimit, creditScore, monthlyIncome, existingCards, employmentMonths };

                factors = [
                    { name: "Credit Score", value: creditScore, required: 680, passed: creditScore >= 680 },
                    { name: "Monthly Income", value: `‚Çπ${monthlyIncome.toLocaleString()}`, required: "‚Çπ30,000", passed: monthlyIncome >= 30000 },
                    { name: "Existing Cards", value: existingCards, required: "‚â§ 2", passed: existingCards <= 2 },
                    { name: "Employment Tenure", value: `${employmentMonths} months`, required: "12 months", passed: employmentMonths >= 12 },
                    { name: "Requested Limit", value: `‚Çπ${creditLimit.toLocaleString()}`, required: "Reasonable", passed: creditLimit <= (monthlyIncome * 5) }
                ];

            } else if (productCategory === 'PERSONALIZED_INVESTMENT') {
                const investmentAmount = parseFloat(document.getElementById('investmentAmount').value);
                const investmentHorizon = parseInt(document.getElementById('investmentHorizon').value);
                const riskAppetite = document.getElementById('riskAppetite').value;
                const creditScore = parseInt(document.getElementById('creditScore').value);
                const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value);

                productData = { ...productData, investmentAmount, investmentHorizon, riskAppetite, creditScore, monthlyIncome };

                factors = [
                    { name: "Credit Score", value: creditScore, required: 650, passed: creditScore >= 650 },
                    { name: "Monthly Income", value: `‚Çπ${monthlyIncome.toLocaleString()}`, required: "‚Çπ25,000", passed: monthlyIncome >= 25000 },
                    { name: "Investment Amount", value: `‚Çπ${investmentAmount.toLocaleString()}/month`, required: "‚â• ‚Çπ500", passed: investmentAmount >= 500 },
                    { name: "Investment Horizon", value: `${investmentHorizon} years`, required: "‚â• 3 years", passed: investmentHorizon >= 3 },
                    { name: "Risk Profile", value: riskAppetite.charAt(0).toUpperCase() + riskAppetite.slice(1), required: "Defined", passed: riskAppetite !== '' }
                ];

            } else if (productCategory === 'PERSONALIZED_INSURANCE') {
                const coverageAmount = parseFloat(document.getElementById('coverageAmount').value);
                const dependents = parseInt(document.getElementById('dependents').value);
                const healthStatus = document.getElementById('healthStatus').value;
                const creditScore = parseInt(document.getElementById('creditScore').value);
                const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value);
                const recommendedCoverage = monthlyIncome * 12 * 10; // 10x annual income

                productData = { ...productData, coverageAmount, dependents, healthStatus, creditScore, monthlyIncome, recommendedCoverage };

                factors = [
                    { name: "Age", value: `${age} years`, required: "18-60", passed: age >= 18 && age <= 60 },
                    { name: "Monthly Income", value: `‚Çπ${monthlyIncome.toLocaleString()}`, required: "‚Çπ20,000", passed: monthlyIncome >= 20000 },
                    { name: "Health Status", value: healthStatus.charAt(0).toUpperCase() + healthStatus.slice(1), required: "Good+", passed: healthStatus === 'excellent' || healthStatus === 'good' },
                    { name: "Coverage Amount", value: `‚Çπ${coverageAmount.toLocaleString()}`, required: "Reasonable", passed: coverageAmount <= recommendedCoverage * 1.5 },
                    { name: "Dependents", value: dependents, required: "Considered", passed: true }
                ];
            }

            // Determine outcome
            const allPassed = factors.every(f => f.passed);
            const outcome = allPassed ? "APPROVED" : "DENIED";

            // Bias detection (works across all products)
            const biasFactors = [];
            const failedFactors = factors.filter(f => !f.passed);
            
            if (age > 60 && failedFactors.length > 0) {
                if (productCategory === 'FRAUD_REVIEW') {
                    biasFactors.push("Elderly customers (60+) - Often flagged as 'unusual activity'");
                } else if (['PERSONALIZED_CAR_LOAN', 'PERSONALIZED_HOME_LOAN'].includes(productCategory) && failedFactors.some(f => f.name.includes('Age'))) {
                    biasFactors.push("Elderly customers (60+) - May be excluded from loan offers due to age criteria");
                } else if (failedFactors.some(f => f.name.includes('Digital') || f.name.includes('Employment'))) {
                    biasFactors.push("Elderly customers (60+)");
                }
            }

            if (locationType === "rural" && failedFactors.length > 0) {
                if (productCategory === 'FRAUD_REVIEW') {
                    biasFactors.push("Rural customers - Flagged due to location-based risk models");
                } else {
                    biasFactors.push("Rural customers");
                }
            }

            if (digitalLiteracy === "low" && failedFactors.some(f => f.name.includes('Digital') || f.name.includes('Usage'))) {
                biasFactors.push("Customers with low digital literacy");
            }

            const biasDetected = biasFactors.length > 0;
            const biasSeverity = biasFactors.length >= 2 ? "HIGH" : (biasFactors.length === 1 ? "MEDIUM" : "LOW");

            // Store current application
            currentApplication = {
                customerName,
                ...productData,
                age,
                locationType,
                digitalLiteracy,
                bankName,
                factors,
                outcome,
                biasDetected,
                biasSeverity,
                biasFactors
            };

            // Display results
            displayResults();
        }

        function displayResults() {
            const app = currentApplication;
            const resultPanel = document.getElementById('resultPanel');
            const resultTitle = document.getElementById('resultTitle');
            const factorsList = document.getElementById('factorsList');
            const biasWarning = document.getElementById('biasWarning');

            // Update title based on product type
            let actionText = "";
            if (app.productCategory === 'FRAUD_REVIEW') {
                actionText = app.outcome === "APPROVED" ? "‚úÖ AI Recommends: LEGITIMATE (Approve Transaction)" : "‚ùå AI Recommends: SUSPICIOUS (Flag for Review)";
            } else if (app.productCategory.startsWith('PERSONALIZED_')) {
                const offerName = app.productCategory.replace('PERSONALIZED_', '').replace('_', ' ').toLowerCase();
                actionText = app.outcome === "APPROVED" ? `‚úÖ AI Recommends: OFFER ${offerName.toUpperCase()}` : "‚ùå AI Recommends: NOT ELIGIBLE";
            } else {
                actionText = app.outcome === "APPROVED" ? "‚úÖ AI Recommends: APPROVE" : "‚ùå AI Recommends: DENY";
            }

            if (app.outcome === "APPROVED") {
                resultPanel.className = "result-panel result-approved";
                resultTitle.textContent = actionText;
            } else {
                resultPanel.className = "result-panel result-denied";
                resultTitle.textContent = actionText;
            }

            // Display factors
            factorsList.innerHTML = app.factors.map(factor => `
                <div class="factor-item">
                    <span class="factor-icon ${factor.passed ? 'factor-passed' : 'factor-failed'}">
                        ${factor.passed ? '‚úì' : '‚úó'}
                    </span>
                    <div style="flex: 1;">
                        <strong>${factor.name}:</strong> ${factor.value} 
                        <span style="color: #999;">(Required: ${factor.required})</span>
                    </div>
                </div>
            `).join('');

            // Display bias warning
            if (app.biasDetected) {
                biasWarning.classList.remove('hidden');
                document.getElementById('biasTitle').textContent = 
                    `${app.biasSeverity} RISK: This decision may disadvantage certain groups`;
                document.getElementById('biasGroups').innerHTML = 
                    `<strong>Affected groups:</strong><br>` + 
                    app.biasFactors.map(g => `‚Ä¢ ${g}`).join('<br>');
            } else {
                biasWarning.classList.add('hidden');
            }

            // Show result panel
            resultPanel.style.display = "block";

            // Update stats
            updateStats();
        }

        async function confirmDecision(finalOutcome) {
            const app = currentApplication;
            if (!app) return;

            // Generate decision ID (use customer ID from form)
            currentDecisionId = generateId("DEC");
            const customerId = document.getElementById('customerId').value.trim();

            // Show loading
            document.getElementById('resultPanel').style.display = "none";
            document.getElementById('loading').classList.remove('hidden');

            // Extract factor values for proper Firebase mapping
            const creditScoreFactor = app.factors.find(f => f.name.includes("Credit Score"));
            const incomeFactor = app.factors.find(f => f.name.includes("Income") && !f.name.includes("Debt"));
            const debtRatioFactor = app.factors.find(f => f.name.includes("Debt"));
            const employmentFactor = app.factors.find(f => f.name.includes("Employment") || f.name.includes("Tenure"));
            const digitalFactor = app.factors.find(f => f.name.includes("Digital") || f.name.includes("Footprint"));
            
            // Create Firebase decision
            const firebaseDecision = {
                id: currentDecisionId,
                customerId: customerId,
                customerName: app.customerName,
                bankName: app.bankName,
                decisionType: app.productCategory,
                timestamp: Date.now(),
                status: "completed",
                
                // Product details (dynamic)
                ...app,

                // Factors breakdown - Map to Firebase model structure
                factors: app.factors.map((f, idx) => ({
                    name: f.name,
                    value: f.value,
                    required: f.required,
                    passed: f.passed
                })),
                
                // Individual factor fields (for app display)
                creditScore: creditScoreFactor ? parseInt(creditScoreFactor.value) || 0 : 0,
                creditScoreRequired: creditScoreFactor ? parseInt(creditScoreFactor.required) || 0 : 0,
                creditScorePassed: creditScoreFactor ? creditScoreFactor.passed : false,
                
                income: incomeFactor ? parseFloat(String(incomeFactor.value).replace(/[‚Çπ,]/g, '')) || 0 : 0,
                incomeRequired: incomeFactor ? parseFloat(String(incomeFactor.required).replace(/[‚Çπ,]/g, '')) || 0 : 0,
                incomePassed: incomeFactor ? incomeFactor.passed : false,
                
                debtRatio: debtRatioFactor ? parseFloat(String(debtRatioFactor.value).replace('%', '')) / 100 || 0 : 0,
                debtRatioRequired: debtRatioFactor ? parseFloat(String(debtRatioFactor.required).replace(/[‚â§%]/g, '')) / 100 || 0 : 0,
                debtRatioPassed: debtRatioFactor ? debtRatioFactor.passed : false,
                
                employmentMonths: employmentFactor ? parseInt(String(employmentFactor.value).replace(/[^\d]/g, '')) || 0 : 0,
                employmentMonthsRequired: employmentFactor ? parseInt(String(employmentFactor.required).replace(/[^\d]/g, '')) || 0 : 0,
                employmentPassed: employmentFactor ? employmentFactor.passed : false,
                
                digitalFootprint: digitalFactor ? String(digitalFactor.value).toLowerCase() : "",
                digitalFootprintRequired: digitalFactor ? String(digitalFactor.required).toLowerCase() : "",
                digitalFootprintPassed: digitalFactor ? digitalFactor.passed : false,

                // Customer profile
                age: app.age,
                locationType: app.locationType,
                digitalLiteracy: app.digitalLiteracy,

                // Bias detection
                biasDetected: app.biasDetected,
                biasSeverity: app.biasSeverity,
                biasMessage: app.biasDetected ? 
                    `${app.biasSeverity} RISK: This decision may disadvantage certain groups` : "",
                biasAffectedGroups: app.biasFactors.join(", "),

                // CRITICAL: Banker's final decision overrides AI recommendation
                outcome: finalOutcome,

                // Summaries (MUST use finalOutcome, not app.outcome)
                summaryEnglish: generateSummary("en", finalOutcome, app),
                summaryHindi: generateSummary("hi", finalOutcome, app),
                summaryTelugu: generateSummary("te", finalOutcome, app),
                
                // Improvement paths for denied applications
                improvementPathsEnglish: finalOutcome === "DENIED" ? JSON.stringify(generateImprovementPaths(app, "en")) : "",
                improvementPathsHindi: finalOutcome === "DENIED" ? JSON.stringify(generateImprovementPaths(app, "hi")) : "",

                // Status flags
                appealRequested: false,
                notificationSent: false
            };

            // Submit to Firebase
            if (firebaseInitialized) {
                try {
                    await database.ref('decisions/' + currentDecisionId).set(firebaseDecision);
                    await database.ref('pending_decisions/' + customerId + '/' + currentDecisionId).set({
                        decisionId: currentDecisionId,
                        timestamp: Date.now(),
                        outcome: finalOutcome,
                        notified: false
                    });
                    console.log("‚úÖ Decision sent to Firebase:", currentDecisionId);
                    
                    // Generate fraud alerts and personalized offers (skip if bias detected)
                    await generateFraudAlerts(customerId, app);
                    
                    if (!app.biasDetected) {
                        console.log('üîç Generating offers for:', customerId, finalOutcome);
                        const generatedOffers = await generatePersonalizedOffers(customerId, app, finalOutcome);
                        console.log('üì¶ Generated offers:', generatedOffers);
                        console.log('üìä Offers count:', generatedOffers ? generatedOffers.length : 'null');
                        
                        // Display offers on portal
                        displayPersonalizedOffers(generatedOffers);
                    } else {
                        console.log('üö´ BIAS DETECTED - Skipping personalized offers generation');
                    }
                } catch (error) {
                    console.error("‚ùå Firebase error:", error);
                }
            } else {
                // Demo mode - simulate delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                console.log("üì± Demo mode: Decision created locally");
                
                // Generate offers even in demo mode (skip if bias detected)
                if (!app.biasDetected) {
                    const generatedOffers = await generatePersonalizedOffers(customerId, app, finalOutcome);
                    displayPersonalizedOffers(generatedOffers);
                } else {
                    console.log('üö´ BIAS DETECTED - Skipping personalized offers generation (demo mode)');
                }
            }

            // Show success
            document.getElementById('loading').classList.add('hidden');
            const successMsg = document.getElementById('successMessage');
            successMsg.innerHTML = `
                ‚úÖ <strong>Decision sent successfully!</strong><br>
                Customer ID: ${customerId}<br>
                Decision ID: ${currentDecisionId}<br>
                Customer will receive instant notification on their mobile app.
            `;
            successMsg.classList.remove('hidden');

            // Reset form after 3 seconds
            setTimeout(() => {
                document.getElementById('loanForm').reset();
                successMsg.classList.add('hidden');
                currentApplication = null;
            }, 3000);
        }

        function generateImprovementPaths(app, lang = "en") {
            const failedFactors = app.factors.filter(f => !f.passed);
            if (failedFactors.length === 0) return [];
            
            const improvements = [];
            
            failedFactors.forEach(factor => {
                let path = { factor: factor.name, current: factor.value, required: factor.required, steps: [] };
                
                if (factor.name.includes("Credit Score")) {
                    const gap = parseInt(factor.required) - parseInt(factor.value);
                    path.steps = lang === "en" ? [
                        `Pay all outstanding bills on time for the next 6-12 months`,
                        `Reduce credit card utilization below 30% (currently need ${gap} point improvement)`,
                        `Check your credit report for errors and dispute any inaccuracies`,
                        `Don't apply for multiple new credit cards in a short period`,
                        `Keep older credit accounts active to improve credit history length`
                    ] : [
                        `‡§Ö‡§ó‡§≤‡•á 6-12 ‡§Æ‡§π‡•Ä‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∏‡§≠‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§¨‡§ø‡§≤‡•ã‡§Ç ‡§ï‡§æ ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡§æ‡§∞‡•ç‡§° ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•ã 30% ‡§∏‡•á ‡§®‡•Ä‡§ö‡•á ‡§∞‡§ñ‡•á‡§Ç`,
                        `‡§Ö‡§™‡§®‡•Ä ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§ï‡§Æ ‡§∏‡§Æ‡§Ø ‡§Æ‡•á‡§Ç ‡§ï‡§à ‡§®‡§è ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡§æ‡§∞‡•ç‡§° ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡•á‡§¶‡§® ‡§® ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ñ‡§æ‡§§‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§∞‡§ñ‡•á‡§Ç`
                    ];
                } else if (factor.name.includes("Income")) {
                    path.steps = lang === "en" ? [
                        `Apply for promotions or salary increments at your current job`,
                        `Consider taking on freelance/consulting work in your field`,
                        `Explore additional income sources like part-time work or investments`,
                        `Update your income documentation with your latest payslips`,
                        `Include all regular bonuses and allowances in your application`
                    ] : [
                        `‡§Ö‡§™‡§®‡•Ä ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§®‡•å‡§ï‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§™‡§¶‡•ã‡§®‡•ç‡§®‡§§‡§ø ‡§Ø‡§æ ‡§µ‡•á‡§§‡§® ‡§µ‡•É‡§¶‡•ç‡§ß‡§ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§Ö‡§™‡§®‡•á ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§´‡•ç‡§∞‡•Ä‡§≤‡§æ‡§Ç‡§∏/‡§™‡§∞‡§æ‡§Æ‡§∞‡•ç‡§∂ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§≤‡•á‡§®‡•á ‡§™‡§∞ ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§Ü‡§Ø ‡§∏‡•ç‡§∞‡•ã‡§§‡•ã‡§Ç ‡§ï‡•Ä ‡§§‡§≤‡§æ‡§∂ ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§Ö‡§™‡§®‡•Ä ‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§™‡•á‡§∏‡•ç‡§≤‡§ø‡§™ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ü‡§Ø ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§Ö‡§™‡§®‡•á ‡§Ü‡§µ‡•á‡§¶‡§® ‡§Æ‡•á‡§Ç ‡§∏‡§≠‡•Ä ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§¨‡•ã‡§®‡§∏ ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§∞‡•á‡§Ç`
                    ];
                } else if (factor.name.includes("Debt")) {
                    path.steps = lang === "en" ? [
                        `Pay down high-interest debts first (credit cards, personal loans)`,
                        `Consolidate multiple debts into a single lower-interest loan`,
                        `Create a monthly budget and stick to it to avoid new debt`,
                        `Increase your EMI payments if possible to reduce debt faster`,
                        `Avoid taking on new loans until your debt ratio improves`
                    ] : [
                        `‡§™‡§π‡§≤‡•á ‡§â‡§ö‡•ç‡§ö-‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ã‡§£ ‡§ö‡•Å‡§ï‡§æ‡§è‡§Ç`,
                        `‡§ï‡§à ‡§ã‡§£‡•ã‡§Ç ‡§ï‡•ã ‡§è‡§ï ‡§ï‡§Æ-‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ã‡§£ ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡•á‡§ï‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§¨‡§ú‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§®‡§è ‡§ã‡§£ ‡§∏‡•á ‡§¨‡§ö‡•á‡§Ç`,
                        `‡§Ø‡§¶‡§ø ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•ã ‡§§‡•ã ‡§Ö‡§™‡§®‡•Ä ‡§à‡§è‡§Æ‡§Ü‡§à ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§¨‡§¢‡§º‡§æ‡§è‡§Ç`,
                        `‡§ú‡§¨ ‡§§‡§ï ‡§ã‡§£ ‡§Ö‡§®‡•Å‡§™‡§æ‡§§ ‡§Æ‡•á‡§Ç ‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§® ‡§π‡•ã, ‡§®‡§è ‡§ã‡§£ ‡§∏‡•á ‡§¨‡§ö‡•á‡§Ç`
                    ];
                } else if (factor.name.includes("Employment") || factor.name.includes("Tenure")) {
                    const monthsNeeded = parseInt(String(factor.required).replace(/[^\d]/g, '')) - parseInt(String(factor.value).replace(/[^\d]/g, ''));
                    path.steps = lang === "en" ? [
                        `Continue in your current role for ${monthsNeeded} more months to meet requirements`,
                        `Maintain good performance reviews and avoid job changes`,
                        `Consider applying with a co-applicant who has longer tenure`,
                        `Provide additional documentation of job stability (offer letter, contracts)`,
                        `Build your professional network to ensure long-term employment security`
                    ] : [
                        `‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§™‡•Ç‡§∞‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ${monthsNeeded} ‡§î‡§∞ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§Ö‡§™‡§®‡•Ä ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç`,
                        `‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§¨‡§®‡§æ‡§è ‡§∞‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§®‡•å‡§ï‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§∏‡•á ‡§¨‡§ö‡•á‡§Ç`,
                        `‡§≤‡§Ç‡§¨‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§æ‡§≤ ‡§µ‡§æ‡§≤‡•á ‡§∏‡§π-‡§Ü‡§µ‡•á‡§¶‡§ï ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§®‡•å‡§ï‡§∞‡•Ä ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ ‡§ï‡§æ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º‡•Ä‡§ï‡§∞‡§£ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§¶‡•Ä‡§∞‡•ç‡§ò‡§ï‡§æ‡§≤‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§®‡§æ ‡§™‡•á‡§∂‡•á‡§µ‡§∞ ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§¨‡§®‡§æ‡§è‡§Ç`
                    ];
                } else if (factor.name.includes("Digital")) {
                    path.steps = lang === "en" ? [
                        `Set up and regularly use mobile/internet banking`,
                        `Make online bill payments and UPI transactions`,
                        `Maintain an active email and update it with your bank`,
                        `Use bank's mobile app for at least 3-6 months`,
                        `Enable two-factor authentication and keep contact details updated`
                    ] : [
                        `‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤/‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§¨‡•à‡§Ç‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§¨‡§ø‡§≤ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§î‡§∞ ‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§è‡§ï ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§∞‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§á‡§∏‡•á ‡§Ö‡§™‡§®‡•á ‡§¨‡•à‡§Ç‡§ï ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 3-6 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡•à‡§Ç‡§ï ‡§ï‡•á ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§ê‡§™ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç`,
                        `‡§¶‡•ã-‡§ï‡§æ‡§∞‡§ï ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§Ö‡§™‡§°‡•á‡§ü ‡§∞‡§ñ‡•á‡§Ç`
                    ];
                }
                
                improvements.push(path);
            });
            
            return improvements;
        }
        
        function generateSummary(lang, outcome, app) {
            const failedFactors = app.factors.filter(f => !f.passed).map(f => f.name.toLowerCase()).join(", ");
            const allPassed = app.factors.every(f => f.passed);
            
            if (lang === "en") {
                if (app.productCategory === 'LOAN') {
                    if (outcome === "APPROVED") {
                        return `Your ${app.loanType?.replace('_', ' ').toLowerCase() || 'loan'} application has been approved! You meet all required criteria.`;
                    } else {
                        // BIAS: All factors passed but still denied
                        if (allPassed) {
                            return `Your loan application was denied despite meeting all eligibility criteria. This decision has been flagged for potential bias review.`;
                        } else {
                            return `Your loan application was denied due to: ${failedFactors}. Tap on improvement paths below to see specific steps to become eligible.`;
                        }
                    }
                } else if (app.productCategory === 'CREDIT_CARD') {
                    if (outcome === "APPROVED") {
                        return `Congratulations! Your credit card application has been approved for a limit of ‚Çπ${app.creditLimit?.toLocaleString()}.`;
                    } else {
                        return `Your credit card application was not approved due to: ${failedFactors}. We've outlined steps to improve your chances.`;
                    }
                } else if (app.productCategory === 'FRAUD_REVIEW') {
                    if (outcome === "APPROVED") {
                        return `Transaction verified as legitimate. The transaction of ‚Çπ${app.transactionAmount?.toLocaleString()} has been approved and processed.`;
                    } else {
                        return `Transaction flagged as suspicious based on: ${failedFactors}. Please contact us to verify this transaction.`;
                    }
                } else if (app.productCategory === 'PERSONALIZED_CAR_LOAN') {
                    if (outcome === "APPROVED") {
                        return `Congratulations! You're eligible for a car loan up to ‚Çπ${app.loanAmount?.toLocaleString()}. Our AI analyzed your credit profile, income stability, and repayment capacity.`;
                    } else {
                        return `You don't currently qualify for this car loan offer due to: ${failedFactors}. We've provided specific steps to improve your eligibility.`;
                    }
                } else if (app.productCategory === 'PERSONALIZED_HOME_LOAN') {
                    if (outcome === "APPROVED") {
                        return `Congratulations! You're eligible for a home loan up to ‚Çπ${app.loanAmount?.toLocaleString()}. Our AI assessed your financial stability, credit worthiness, and long-term repayment capacity.`;
                    } else {
                        return `You don't currently qualify for this home loan offer due to: ${failedFactors}. We've outlined specific steps to become eligible.`;
                    }
                } else if (app.productCategory === 'PERSONALIZED_CREDIT_CARD') {
                    if (outcome === "APPROVED") {
                        return `Congratulations! You're eligible for a premium credit card with limit of ‚Çπ${app.creditLimit?.toLocaleString()}. Our AI evaluated your credit history, income, and spending patterns.`;
                    } else {
                        return `You don't currently qualify for this credit card offer due to: ${failedFactors}. We've shared steps to improve your credit profile.`;
                    }
                } else if (app.productCategory === 'PERSONALIZED_INVESTMENT') {
                    if (outcome === "APPROVED") {
                        return `Great! You're ready to start investing with ‚Çπ${app.investmentAmount?.toLocaleString()}/month. Our AI matched your risk profile and financial goals to recommend suitable investment options.`;
                    } else {
                        return `Based on your current profile, we recommend improving: ${failedFactors}. We'll help you become investment-ready.`;
                    }
                } else if (app.productCategory === 'PERSONALIZED_INSURANCE') {
                    if (outcome === "APPROVED") {
                        return `You're eligible for life insurance coverage of ‚Çπ${app.coverageAmount?.toLocaleString()}. Our AI considered your age, health status, income, and family needs to determine appropriate coverage.`;
                    } else {
                        return `Based on: ${failedFactors}, we recommend adjusting your insurance plan. We'll help you find the right coverage.`;
                    }
                }
            } else if (lang === "hi") {
                // Hindi translations
                if (app.productCategory === 'LOAN') {
                    if (outcome === "APPROVED") {
                        return `‡§Ü‡§™‡§ï‡§æ ‡§ã‡§£ ‡§Ü‡§µ‡•á‡§¶‡§® ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à! ‡§Ü‡§™ ‡§∏‡§≠‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Æ‡§æ‡§®‡§¶‡§Ç‡§°‡•ã‡§Ç ‡§ï‡•ã ‡§™‡•Ç‡§∞‡§æ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§`;
                    } else {
                        return `‡§Ü‡§™‡§ï‡§æ ‡§ã‡§£ ‡§Ü‡§µ‡•á‡§¶‡§® ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§π‡§Æ‡§®‡•á ‡§Ü‡§™‡§ï‡•Ä ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ ‡§¨‡§¢‡§º‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§ï‡§¶‡§Æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§ø‡§è ‡§π‡•à‡§Ç‡•§`;
                    }
                } else if (app.productCategory === 'CREDIT_CARD') {
                    if (outcome === "APPROVED") {
                        return `‡§¨‡§ß‡§æ‡§à ‡§π‡•ã! ‡§Ü‡§™‡§ï‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡§æ‡§∞‡•ç‡§° ‡§Ü‡§µ‡•á‡§¶‡§® ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§`;
                    } else {
                        return `‡§Ü‡§™‡§ï‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡§æ‡§∞‡•ç‡§° ‡§Ü‡§µ‡•á‡§¶‡§® ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü‡•§ ‡§π‡§Æ‡§®‡•á ‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§ï‡•á ‡§ï‡§¶‡§Æ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§ø‡§è ‡§π‡•à‡§Ç‡•§`;
                    }
                } else if (app.productCategory === 'FRAUD_REVIEW') {
                    if (outcome === "APPROVED") {
                        return `‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§µ‡•à‡§ß ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§‡•§ ‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§î‡§∞ ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§ø‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§`;
                    } else {
                        return `‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§∏‡§Ç‡§¶‡§ø‡§ó‡•ç‡§ß ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ö‡§ø‡§π‡•ç‡§®‡§ø‡§§‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§á‡§∏‡•á ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§Æ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§`;
                    }
                } else if (app.productCategory.startsWith('PERSONALIZED_')) {
                    if (outcome === "APPROVED") {
                        return `‡§¨‡§ß‡§æ‡§à ‡§π‡•ã! ‡§Ü‡§™ ‡§á‡§∏ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§ë‡§´‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§§‡•ç‡§∞ ‡§π‡•à‡§Ç‡•§ ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§è‡§Ü‡§à ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä ‡§®‡•á ‡§Ü‡§™‡§ï‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à‡•§`;
                    } else {
                        return `‡§Ü‡§™ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§á‡§∏ ‡§ë‡§´‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç‡•§ ‡§π‡§Æ‡§®‡•á ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ ‡§¨‡§¢‡§º‡§æ‡§®‡•á ‡§ï‡•á ‡§ï‡§¶‡§Æ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§ø‡§è ‡§π‡•à‡§Ç‡•§`;
                    }
                }
            } else if (lang === "te") {
                // Telugu translations
                if (app.productCategory === 'LOAN') {
                    if (outcome === "APPROVED") {
                        return `‡∞Æ‡±Ä ‡∞∞‡±Å‡∞£ ‡∞¶‡∞∞‡∞ñ‡∞æ‡∞∏‡±ç‡∞§‡±Å ‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø! ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞Ö‡∞®‡±ç‡∞®‡∞ø ‡∞Ö‡∞µ‡∞∏‡∞∞‡∞Æ‡±à‡∞® ‡∞™‡±ç‡∞∞‡∞Æ‡∞æ‡∞£‡∞æ‡∞≤‡∞®‡±Å ‡∞§‡±Ä‡∞∞‡±ç‡∞ö‡∞æ‡∞∞‡±Å‡•§`;
                    } else {
                        return `‡∞Æ‡±Ä ‡∞∞‡±Å‡∞£ ‡∞¶‡∞∞‡∞ñ‡∞æ‡∞∏‡±ç‡∞§‡±Å ‡∞§‡∞ø‡∞∞‡∞∏‡±ç‡∞ï‡∞∞‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø. ‡∞Æ‡±Ä ‡∞Ö‡∞∞‡±ç‡∞π‡∞§‡∞®‡±Å ‡∞Æ‡±Ü‡∞∞‡±Å‡∞ó‡±Å‡∞™‡∞∞‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞Æ‡±á‡∞Æ‡±Å ‡∞®‡∞ø‡∞∞‡±ç‡∞¶‡∞ø‡∞∑‡±ç‡∞ü ‡∞¶‡∞∂‡∞≤‡∞®‡±Å ‡∞Ö‡∞Ç‡∞¶‡∞ø‡∞Ç‡∞ö‡∞æ‡∞Æ‡±Å‡•§`;
                    }
                } else if (app.productCategory === 'CREDIT_CARD') {
                    if (outcome === "APPROVED") {
                        return `‡∞Ö‡∞≠‡∞ø‡∞®‡∞Ç‡∞¶‡∞®‡∞≤‡±Å! ‡∞Æ‡±Ä ‡∞ï‡±ç‡∞∞‡±Ü‡∞°‡∞ø‡∞ü‡±ç ‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡±ç ‡∞¶‡∞∞‡∞ñ‡∞æ‡∞∏‡±ç‡∞§‡±Å ‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø.`;
                    } else {
                        return `‡∞Æ‡±Ä ‡∞ï‡±ç‡∞∞‡±Ü‡∞°‡∞ø‡∞ü‡±ç ‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡±ç ‡∞¶‡∞∞‡∞ñ‡∞æ‡∞∏‡±ç‡∞§‡±Å ‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞≤‡±á‡∞¶‡±Å: ${failedFactors}. ‡∞Æ‡±á‡∞Æ‡±Å ‡∞Æ‡±Ü‡∞∞‡±Å‡∞ó‡±Å‡∞™‡∞∞‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞¶‡∞∂‡∞≤‡∞®‡±Å ‡∞™‡∞Ç‡∞ö‡±Å‡∞ï‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞Æ‡±Å.`;
                    }
                } else if (app.productCategory === 'FRAUD_REVIEW') {
                    if (outcome === "APPROVED") {
                        return `‡∞≤‡∞æ‡∞µ‡∞æ‡∞¶‡±á‡∞µ‡±Ä ‡∞ö‡∞ü‡±ç‡∞ü‡∞¨‡∞¶‡±ç‡∞ß‡∞Ç‡∞ó‡∞æ ‡∞ß‡±É‡∞µ‡±Ä‡∞ï‡∞∞‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø. ‡∞≤‡∞æ‡∞µ‡∞æ‡∞¶‡±á‡∞µ‡±Ä ‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞™‡±ç‡∞∞‡∞æ‡∞∏‡±Ü‡∞∏‡±ç ‡∞ö‡±á‡∞Ø‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø.`;
                    } else {
                        return `‡∞≤‡∞æ‡∞µ‡∞æ‡∞¶‡±á‡∞µ‡±Ä ‡∞Ö‡∞®‡±Å‡∞Æ‡∞æ‡∞®‡∞æ‡∞∏‡±ç‡∞™‡∞¶‡∞Ç‡∞ó‡∞æ ‡∞ó‡±Å‡∞∞‡±ç‡∞§‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø. ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞¶‡±Ä‡∞®‡∞ø‡∞®‡∞ø ‡∞ß‡±É‡∞µ‡±Ä‡∞ï‡∞∞‡∞ø‡∞Ç‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞Æ‡∞Æ‡±ç‡∞Æ‡∞≤‡±ç‡∞®‡∞ø ‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø.`;
                    }
                } else if (app.productCategory.startsWith('PERSONALIZED_')) {
                    if (outcome === "APPROVED") {
                        return `‡∞Ö‡∞≠‡∞ø‡∞®‡∞Ç‡∞¶‡∞®‡∞≤‡±Å! ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞à ‡∞µ‡±ç‡∞Ø‡∞ï‡±ç‡∞§‡∞ø‡∞ó‡∞§ ‡∞Ü‡∞´‡∞∞‡±ç‚Äå‡∞ï‡±Å ‡∞Ö‡∞∞‡±ç‡∞π‡±Å‡∞≤‡±Å. ‡∞Æ‡∞æ AI ‡∞∏‡∞ø‡∞∏‡±ç‡∞ü‡∞Æ‡±ç ‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‚Äå‡∞®‡±Å ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞ø‡∞Ç‡∞ö‡∞ø‡∞Ç‡∞¶‡∞ø.`;
                    } else {
                        return `‡∞Æ‡±Ä‡∞∞‡±Å ‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§‡∞Ç ‡∞à ‡∞Ü‡∞´‡∞∞‡±ç‚Äå‡∞ï‡±Å ‡∞Ö‡∞∞‡±ç‡∞π‡±Å‡∞≤‡±Å ‡∞ï‡∞æ‡∞¶‡±Å. ‡∞Æ‡±á‡∞Æ‡±Å ‡∞Ö‡∞∞‡±ç‡∞π‡∞§‡∞®‡±Å ‡∞Æ‡±Ü‡∞∞‡±Å‡∞ó‡±Å‡∞™‡∞∞‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞¶‡∞∂‡∞≤‡∞®‡±Å ‡∞™‡∞Ç‡∞ö‡±Å‡∞ï‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞Æ‡±Å.`;
                    }
                }
            }
            
            return "Decision processed. Please contact your bank for details.";
        }

        function generateId(prefix) {
            return `${prefix}_${Date.now()}_${Math.floor(Math.random() * 9000) + 1000}`;
        }

        function updateStats() {
            // Simple counter for demo
            const total = parseInt(document.getElementById('totalDecisions').textContent) + 1;
            document.getElementById('totalDecisions').textContent = total;
            
            if (currentApplication && currentApplication.biasDetected) {
                const warnings = parseInt(document.getElementById('biasWarnings').textContent) + 1;
                document.getElementById('biasWarnings').textContent = warnings;
            }
        }
        
        // NEW: Fetch customer data (name + consents) in real-time from Firebase
        let fetchTimeout = null;
        async function fetchCustomerData() {
            const customerId = document.getElementById('customerId').value.trim();
            const customerNameInput = document.getElementById('customerName');
            const nameLoadingIndicator = document.getElementById('nameLoadingIndicator');
            const nameLoadedIndicator = document.getElementById('nameLoadedIndicator');
            const nameErrorIndicator = document.getElementById('nameErrorIndicator');
            const consentInfo = document.getElementById('consentInfo');
            const consentDetails = document.getElementById('consentDetails');
            
            // Clear previous timeout (debounce)
            if (fetchTimeout) clearTimeout(fetchTimeout);
            
            // Reset UI if empty
            if (!customerId || !firebaseInitialized) {
                customerNameInput.value = '';
                nameLoadingIndicator.style.display = 'none';
                nameLoadedIndicator.style.display = 'none';
                nameErrorIndicator.style.display = 'none';
                consentInfo.style.display = 'none';
                return;
            }
            
            // Show loading indicator
            nameLoadingIndicator.style.display = 'inline';
            nameLoadedIndicator.style.display = 'none';
            nameErrorIndicator.style.display = 'none';
            
            // Debounce: wait 500ms after user stops typing
            fetchTimeout = setTimeout(async () => {
                try {
                    console.log('üîç Fetching customer data for:', customerId);
                    
                    // Fetch customer profile (for name) - Using 'user_profiles' path
                    const profileSnapshot = await database.ref('user_profiles/' + customerId).once('value');
                    const profile = profileSnapshot.val();
                    console.log('üìã Profile data:', profile);
                    
                    // Fetch consents
                    const consentSnapshot = await database.ref('user_consents/' + customerId).once('value');
                    const consents = consentSnapshot.val();
                    
                    // Auto-populate customer name
                    if (profile && profile.name) {
                        console.log('‚úÖ Customer name found:', profile.name);
                        customerNameInput.value = profile.name;
                        nameLoadingIndicator.style.display = 'none';
                        nameLoadedIndicator.style.display = 'inline';
                        nameErrorIndicator.style.display = 'none';
                    } else {
                        console.log('‚ö†Ô∏è No customer name found');
                        customerNameInput.value = 'Name not found in Lume AI';
                        nameLoadingIndicator.style.display = 'none';
                        nameLoadedIndicator.style.display = 'none';
                        nameErrorIndicator.style.display = 'inline';
                    }
                    
                    // Display consents
                    if (consents) {
                        console.log('‚úÖ Consents found:', consents);
                        
                        let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
                        
                        const consentLabels = {
                            aiAnalysis: 'ü§ñ AI Analysis',
                            biasDetection: '‚öñÔ∏è Bias Detection',
                            dataSharing: 'üîó Data Sharing',
                            dataStorage: 'üíæ Data Storage'
                        };
                        
                        Object.keys(consentLabels).forEach(key => {
                            const granted = consents[key] === true;
                            const icon = granted ? '‚úÖ' : '‚ùå';
                            const bgColor = granted ? 'rgba(255, 255, 255, 0.8)' : 'rgba(255, 255, 255, 0.6)';
                            const borderColor = granted ? 'rgba(102, 126, 234, 0.3)' : 'rgba(220, 38, 38, 0.3)';
                            const textColor = granted ? '#4c51bf' : '#dc2626';
                            const status = granted ? 'GRANTED' : 'DECLINED';
                            
                            html += `<div style="padding: 8px 10px; background: ${bgColor}; backdrop-filter: blur(10px); border-radius: 8px; border: 1px solid ${borderColor}; transition: all 0.2s ease;">
                                ${icon} <strong style="font-size: 11px;">${consentLabels[key]}:</strong>
                                <span style="color: ${textColor}; font-weight: 600; font-size: 11px; margin-left: 4px;">${status}</span>
                            </div>`;
                        });
                        
                        html += '</div>';
                        
                        // Show last updated time
                        if (consents.lastUpdated) {
                            const date = new Date(consents.lastUpdated);
                            html += `<p style="margin-top: 10px; font-size: 11px; color: #64748b; font-weight: 500;">
                                Last updated: ${date.toLocaleString()}
                            </p>`;
                        }
                        
                        // Show warning if critical consents declined
                        if (!consents.aiAnalysis) {
                            html += `<div style="margin-top: 10px; padding: 10px 12px; background: rgba(254, 243, 199, 0.5); border-radius: 8px; color: #92400e; border: 1px solid rgba(245, 158, 11, 0.3); font-size: 12px;">
                                ‚ö†Ô∏è <strong>Note:</strong> Customer has declined AI Analysis. Proceed with manual review.
                            </div>`;
                        }
                        
                        consentDetails.innerHTML = html;
                        consentInfo.style.display = 'block';
                    } else {
                        console.log('‚ÑπÔ∏è No consents found for customer');
                        consentDetails.innerHTML = `<div style="color: #6b7280; background: rgba(255, 255, 255, 0.6); padding: 10px 12px; border-radius: 8px; font-size: 12px; line-height: 1.5;">
                            ‚ÑπÔ∏è <strong style="color: #4c51bf;">No consent preferences found.</strong> Customer may need to grant consents in the mobile app.
                        </div>`;
                        consentInfo.style.display = 'block';
                    }
                } catch (error) {
                    console.error('‚ùå Error fetching customer data:', error);
                    customerNameInput.value = 'Error loading from Lume AI';
                    nameLoadingIndicator.style.display = 'none';
                    nameLoadedIndicator.style.display = 'none';
                    nameErrorIndicator.style.display = 'inline';
                    consentInfo.style.display = 'none';
                }
            }, 500); // 500ms debounce
        }

        /**
         * Generate realistic fraud alerts for the customer
         */
        async function generateFraudAlerts(customerId, app) {
            try {
                // Generate 1-2 fraud alerts per customer
                const alertCount = Math.random() > 0.5 ? 2 : 1;
                
                for (let i = 0; i < alertCount; i++) {
                    const alertId = 'fraud_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    // Random transaction types and details
                    const transactionTypes = ['TRANSFER', 'PAYMENT', 'WITHDRAWAL', 'PURCHASE'];
                    const transactionType = transactionTypes[Math.floor(Math.random() * transactionTypes.length)];
                    
                    const merchants = [
                        { name: 'Amazon India', category: 'online', location: 'Mumbai, India' },
                        { name: 'International Travel Agency', category: 'international', location: 'Dubai, UAE' },
                        { name: 'ATM Withdrawal', category: 'atm', location: 'Bangalore, India' },
                        { name: 'Luxury Store', category: 'retail', location: 'Delhi, India' },
                        { name: 'Online Gaming Site', category: 'online', location: 'Singapore' }
                    ];
                    const merchant = merchants[Math.floor(Math.random() * merchants.length)];
                    
                    // Risk levels based on patterns
                    const riskLevels = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
                    const riskWeights = [0.4, 0.35, 0.2, 0.05]; // Probability weights
                    const riskLevel = weightedRandom(riskLevels, riskWeights);
                    
                    const riskScore = riskLevel === 'LOW' ? 20 + Math.random() * 20 :
                                     riskLevel === 'MEDIUM' ? 40 + Math.random() * 20 :
                                     riskLevel === 'HIGH' ? 60 + Math.random() * 20 :
                                     80 + Math.random() * 20;
                    
                    const amount = riskLevel === 'LOW' ? 500 + Math.random() * 2000 :
                                  riskLevel === 'MEDIUM' ? 3000 + Math.random() * 7000 :
                                  riskLevel === 'HIGH' ? 10000 + Math.random() * 40000 :
                                  50000 + Math.random() * 100000;
                    
                    // Determine status based on risk
                    const status = riskLevel === 'CRITICAL' ? 'BLOCKED' :
                                  riskLevel === 'HIGH' ? 'FLAGGED' :
                                  riskLevel === 'MEDIUM' ? 'UNDER_REVIEW' :
                                  'APPROVED';
                    
                    // Fraud factors
                    const unusualAmount = riskLevel === 'HIGH' || riskLevel === 'CRITICAL';
                    const unusualLocation = merchant.category === 'international' || riskLevel === 'CRITICAL';
                    const unusualTime = Math.random() > 0.6;
                    const newMerchant = Math.random() > 0.5;
                    const multipleAttempts = riskLevel === 'CRITICAL';
                    const deviceMismatch = riskLevel === 'HIGH' || riskLevel === 'CRITICAL';
                    
                    // Generate reasons
                    const reasonEnglish = generateFraudReason(riskLevel, transactionType, amount, merchant, {
                        unusualAmount, unusualLocation, unusualTime, newMerchant, multipleAttempts, deviceMismatch
                    });
                    
                    const reasonHindi = "‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§è‡§Ü‡§à ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä ‡§®‡•á ‡§á‡§∏ ‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§™‡•à‡§ü‡§∞‡•ç‡§® ‡§ï‡§æ ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§Ø‡§æ ‡§π‡•à‡•§ ‡§Ø‡§π ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ñ‡§∞‡•ç‡§ö ‡§Ü‡§¶‡§§‡•ã‡§Ç ‡§∏‡•á ‡§Æ‡•á‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§ñ‡§æ‡§§‡§æ‡•§";
                    const reasonTelugu = "‡∞Æ‡∞æ AI ‡∞∏‡∞ø‡∞∏‡±ç‡∞ü‡∞Æ‡±ç ‡∞à ‡∞≤‡∞æ‡∞µ‡∞æ‡∞¶‡±á‡∞µ‡±Ä‡∞≤‡±ã ‡∞Ö‡∞∏‡∞æ‡∞ß‡∞æ‡∞∞‡∞£ ‡∞®‡∞Æ‡±Ç‡∞®‡∞æ‡∞≤‡∞®‡±Å ‡∞ó‡±Å‡∞∞‡±ç‡∞§‡∞ø‡∞Ç‡∞ö‡∞ø‡∞Ç‡∞¶‡∞ø. ‡∞á‡∞¶‡∞ø ‡∞Æ‡±Ä ‡∞∏‡∞æ‡∞ß‡∞æ‡∞∞‡∞£ ‡∞ñ‡∞∞‡±ç‡∞ö‡±Å ‡∞Ö‡∞≤‡∞µ‡∞æ‡∞ü‡±ç‡∞≤‡∞ï‡±Å ‡∞∏‡∞∞‡∞ø‡∞™‡±ã‡∞≤‡∞°‡∞Ç ‡∞≤‡±á‡∞¶‡±Å.";
                    
                    const recommendationEnglish = riskLevel === 'CRITICAL' ? 
                        "Transaction blocked for your security. Please verify this transaction by calling our helpline immediately." :
                        riskLevel === 'HIGH' ?
                        "Transaction flagged for review. Please confirm if this transaction was made by you. If not, report it immediately." :
                        "Monitor your account for any unusual activity. Enable transaction alerts for real-time notifications.";
                    
                    const recommendationHindi = "‡§Ö‡§™‡§®‡•á ‡§ñ‡§æ‡§§‡•á ‡§ï‡•Ä ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§á‡§∏ ‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§π‡§Æ‡§æ‡§∞‡•á ‡§π‡•á‡§≤‡•ç‡§™‡§≤‡§æ‡§á‡§® ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§";
                    const recommendationTelugu = "‡∞Æ‡±Ä ‡∞ñ‡∞æ‡∞§‡∞æ ‡∞≠‡∞¶‡±ç‡∞∞‡∞§ ‡∞ï‡±ã‡∞∏‡∞Ç, ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞à ‡∞≤‡∞æ‡∞µ‡∞æ‡∞¶‡±á‡∞µ‡±Ä‡∞®‡∞ø ‡∞ß‡±É‡∞µ‡±Ä‡∞ï‡∞∞‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø ‡∞≤‡±á‡∞¶‡∞æ ‡∞Æ‡∞æ ‡∞π‡±Ü‡∞≤‡±ç‡∞™‡±ç‚Äå‡∞≤‡±à‡∞®‡±ç‚Äå‡∞®‡∞ø ‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø.";
                    
                    const fraudAlert = {
                        id: alertId,
                        customerId: customerId,
                        customerName: app.customerName || 'Customer',
                        bankName: app.bankName || 'HDFC Bank',
                        timestamp: Date.now() - (Math.random() * 7 * 24 * 60 * 60 * 1000), // Within last 7 days
                        
                        // Transaction details
                        transactionId: 'TXN' + Date.now().toString().substr(-10),
                        transactionType: transactionType,
                        amount: Math.round(amount),
                        currency: 'INR',
                        merchantName: merchant.name,
                        merchantCategory: merchant.category,
                        location: merchant.location,
                        deviceId: 'device_' + Math.random().toString(36).substr(2, 8),
                        
                        // Fraud detection
                        riskLevel: riskLevel,
                        riskScore: Math.round(riskScore),
                        fraudDetected: riskLevel === 'HIGH' || riskLevel === 'CRITICAL',
                        status: status,
                        
                        // AI Decision factors
                        unusualAmount: unusualAmount,
                        unusualLocation: unusualLocation,
                        unusualTime: unusualTime,
                        newMerchant: newMerchant,
                        multipleAttempts: multipleAttempts,
                        deviceMismatch: deviceMismatch,
                        
                        // Explanations
                        reasonEnglish: reasonEnglish,
                        reasonHindi: reasonHindi,
                        reasonTelugu: reasonTelugu,
                        recommendationEnglish: recommendationEnglish,
                        recommendationHindi: recommendationHindi,
                        recommendationTelugu: recommendationTelugu,
                        
                        // User actions
                        userNotified: true,
                        userConfirmed: false,
                        userReportedFraud: false
                    };
                    
                    // Save to Firebase
                    await database.ref('fraudAlerts/' + alertId).set(fraudAlert);
                    console.log(`üö® Fraud alert generated: ${alertId} (${riskLevel})`);
                    
                    // Small delay between alerts
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            } catch (error) {
                console.error("‚ùå Error generating fraud alerts:", error);
            }
        }

        function generateFraudReason(riskLevel, transactionType, amount, merchant, factors) {
            let reason = `This ${transactionType.toLowerCase()} transaction of ‚Çπ${Math.round(amount).toLocaleString()} at ${merchant.name} was flagged due to: `;
            
            const detectedFactors = [];
            if (factors.unusualAmount) detectedFactors.push("unusual transaction amount");
            if (factors.unusualLocation) detectedFactors.push("transaction from unusual location");
            if (factors.unusualTime) detectedFactors.push("transaction at unusual time");
            if (factors.newMerchant) detectedFactors.push("new merchant");
            if (factors.multipleAttempts) detectedFactors.push("multiple failed attempts");
            if (factors.deviceMismatch) detectedFactors.push("unrecognized device");
            
            reason += detectedFactors.join(", ") + ". Our AI system analyzes your spending patterns, location history, and device usage to protect your account from fraudulent activities.";
            
            return reason;
        }

        /**
         * Translation mappings for offer titles and product names
         */
        const offerTranslations = {
            // Credit Cards
            'HDFC Millennia Credit Card': {
                hi: 'HDFC ‡§Æ‡§ø‡§≤‡•á‡§®‡§ø‡§Ø‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡§æ‡§∞‡•ç‡§°',
                te: 'HDFC ‡∞Æ‡∞ø‡∞≤‡±Ä‡∞®‡∞ø‡∞Ø‡∞æ ‡∞ï‡±ç‡∞∞‡±Ü‡∞°‡∞ø‡∞ü‡±ç ‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡±ç'
            },
            'üí≥ Premium Credit Card with 5% Cashback': {
                hi: 'üí≥ 5% ‡§ï‡•à‡§∂‡§¨‡•à‡§ï ‡§ï‡•á ‡§∏‡§æ‡§• ‡§™‡•ç‡§∞‡•Ä‡§Æ‡§ø‡§Ø‡§Æ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡§æ‡§∞‡•ç‡§°',
                te: 'üí≥ 5% ‡∞ï‡±ç‡∞Ø‡∞æ‡∞∑‡±ç‚Äå‡∞¨‡±ç‡∞Ø‡∞æ‡∞ï‡±ç‚Äå‡∞§‡±ã ‡∞™‡±ç‡∞∞‡±Ä‡∞Æ‡∞ø‡∞Ø‡∞Ç ‡∞ï‡±ç‡∞∞‡±Ü‡∞°‡∞ø‡∞ü‡±ç ‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡±ç'
            },
            'HDFC MoneyBack Credit Card': {
                hi: 'HDFC ‡§Æ‡§®‡•Ä‡§¨‡•à‡§ï ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡§æ‡§∞‡•ç‡§°',
                te: 'HDFC ‡∞Æ‡∞®‡±Ä‡∞¨‡±ç‡∞Ø‡∞æ‡∞ï‡±ç ‡∞ï‡±ç‡∞∞‡±Ü‡∞°‡∞ø‡∞ü‡±ç ‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡±ç'
            },
            'üí≥ Starter Credit Card with 2% Cashback': {
                hi: 'üí≥ 2% ‡§ï‡•à‡§∂‡§¨‡•à‡§ï ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡•ç‡§ü‡§æ‡§∞‡•ç‡§ü‡§∞ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡§æ‡§∞‡•ç‡§°',
                te: 'üí≥ 2% ‡∞ï‡±ç‡∞Ø‡∞æ‡∞∑‡±ç‚Äå‡∞¨‡±ç‡∞Ø‡∞æ‡∞ï‡±ç‚Äå‡∞§‡±ã ‡∞∏‡±ç‡∞ü‡∞æ‡∞∞‡±ç‡∞ü‡∞∞‡±ç ‡∞ï‡±ç‡∞∞‡±Ü‡∞°‡∞ø‡∞ü‡±ç ‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡±ç'
            },
            // Loans
            'HDFC Personal Loan Top-Up': {
                hi: 'HDFC ‡§™‡§∞‡•ç‡§∏‡§®‡§≤ ‡§≤‡•ã‡§® ‡§ü‡•â‡§™-‡§Ö‡§™',
                te: 'HDFC ‡∞™‡∞∞‡±ç‡∞∏‡∞®‡∞≤‡±ç ‡∞≤‡±ã‡∞®‡±ç ‡∞ü‡∞æ‡∞™‡±ç-‡∞Ö‡∞™‡±ç'
            },
            'üí∞ Top-Up Loan Available': {
                hi: 'üí∞ ‡§ü‡•â‡§™-‡§Ö‡§™ ‡§≤‡•ã‡§® ‡§â‡§™‡§≤‡§¨‡•ç‡§ß',
                te: 'üí∞ ‡∞ü‡∞æ‡∞™‡±ç-‡∞Ö‡∞™‡±ç ‡∞≤‡±ã‡∞®‡±ç ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã'
            },
            'HDFC Secured Personal Loan': {
                hi: 'HDFC ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§™‡§∞‡•ç‡§∏‡§®‡§≤ ‡§≤‡•ã‡§®',
                te: 'HDFC ‡∞∏‡±Å‡∞∞‡∞ï‡±ç‡∞∑‡∞ø‡∞§ ‡∞µ‡±ç‡∞Ø‡∞ï‡±ç‡∞§‡∞ø‡∞ó‡∞§ ‡∞∞‡±Å‡∞£‡∞Ç'
            },
            'üí∞ Secured Loan - Alternative Option': {
                hi: 'üí∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§≤‡•ã‡§® - ‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™',
                te: 'üí∞ ‡∞∏‡±Å‡∞∞‡∞ï‡±ç‡∞∑‡∞ø‡∞§ ‡∞≤‡±ã‡∞®‡±ç - ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞æ‡∞Æ‡±ç‡∞®‡∞æ‡∞Ø ‡∞é‡∞Ç‡∞™‡∞ø‡∞ï'
            },
            'HDFC Home Loan': {
                hi: 'HDFC ‡§π‡•ã‡§Æ ‡§≤‡•ã‡§®',
                te: 'HDFC ‡∞π‡±ã‡∞Æ‡±ç ‡∞≤‡±ã‡∞®‡±ç'
            },
            'üè† Home Loan up to ‚Çπ1 Crore': {
                hi: 'üè† ‚Çπ1 ‡§ï‡§∞‡•ã‡§°‡§º ‡§§‡§ï ‡§π‡•ã‡§Æ ‡§≤‡•ã‡§®',
                te: 'üè† ‚Çπ1 ‡∞ï‡±ã‡∞ü‡∞ø ‡∞µ‡∞∞‡∞ï‡±Å ‡∞π‡±ã‡∞Æ‡±ç ‡∞≤‡±ã‡∞®‡±ç'
            },
            // Investments
            'HDFC Mutual Fund SIP': {
                hi: 'HDFC ‡§Æ‡•ç‡§Ø‡•Ç‡§ö‡•Å‡§Ö‡§≤ ‡§´‡§Ç‡§° SIP',
                te: 'HDFC ‡∞Æ‡±ç‡∞Ø‡±Ç‡∞ö‡±Å‡∞µ‡∞≤‡±ç ‡∞´‡∞Ç‡∞°‡±ç SIP'
            },
            'üìà Systematic Investment Plan': {
                hi: 'üìà ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§ø‡§§ ‡§®‡§ø‡§µ‡•á‡§∂ ‡§Ø‡•ã‡§ú‡§®‡§æ',
                te: 'üìà ‡∞ï‡±ç‡∞∞‡∞Æ‡∞æ‡∞®‡±Å‡∞ó‡∞§ ‡∞™‡±Ü‡∞ü‡±ç‡∞ü‡±Å‡∞¨‡∞°‡∞ø ‡∞™‡±ç‡∞∞‡∞£‡∞æ‡∞≥‡∞ø‡∞ï'
            },
            'HDFC Fixed Deposit': {
                hi: 'HDFC ‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§° ‡§°‡§ø‡§™‡•â‡§ú‡§ø‡§ü',
                te: 'HDFC ‡∞´‡∞ø‡∞ï‡±ç‡∞∏‡±ç‚Äå‡∞°‡±ç ‡∞°‡∞ø‡∞™‡∞æ‡∞ú‡∞ø‡∞ü‡±ç'
            },
            'üíé Safe Investment with Guaranteed Returns': {
                hi: 'üíé ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä‡§° ‡§∞‡§ø‡§ü‡§∞‡•ç‡§® ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§®‡§ø‡§µ‡•á‡§∂',
                te: 'üíé ‡∞π‡∞æ‡∞Æ‡±Ä ‡∞∞‡∞ø‡∞ü‡∞∞‡±ç‡∞®‡±ç‚Äå‡∞≤‡∞§‡±ã ‡∞∏‡±Å‡∞∞‡∞ï‡±ç‡∞∑‡∞ø‡∞§‡∞Æ‡±à‡∞® ‡∞™‡±Ü‡∞ü‡±ç‡∞ü‡±Å‡∞¨‡∞°‡∞ø'
            },
            // Insurance
            'HDFC Life Term Insurance': {
                hi: 'HDFC ‡§≤‡§æ‡§á‡§´ ‡§ü‡§∞‡•ç‡§Æ ‡§á‡§Ç‡§∂‡•ç‡§Ø‡•ã‡§∞‡•á‡§Ç‡§∏',
                te: 'HDFC ‡∞≤‡±à‡∞´‡±ç ‡∞ü‡∞∞‡±ç‡∞Æ‡±ç ‡∞á‡∞®‡±ç‡∞∏‡±Ç‡∞∞‡±Ü‡∞®‡±ç‡∞∏‡±ç'
            },
            'üõ°Ô∏è Life Insurance Coverage': {
                hi: 'üõ°Ô∏è ‡§ú‡•Ä‡§µ‡§® ‡§¨‡•Ä‡§Æ‡§æ ‡§ï‡§µ‡§∞‡•á‡§ú',
                te: 'üõ°Ô∏è ‡∞ú‡±Ä‡∞µ‡∞ø‡∞§ ‡∞¨‡±Ä‡∞Æ‡∞æ ‡∞ï‡∞µ‡∞∞‡±á‡∞ú‡±ç'
            },
            'HDFC Health Insurance': {
                hi: 'HDFC ‡§π‡•á‡§≤‡•ç‡§• ‡§á‡§Ç‡§∂‡•ç‡§Ø‡•ã‡§∞‡•á‡§Ç‡§∏',
                te: 'HDFC ‡∞Ü‡∞∞‡±ã‡∞ó‡±ç‡∞Ø ‡∞¨‡±Ä‡∞Æ‡∞æ'
            },
            'üè• Comprehensive Health Coverage': {
                hi: 'üè• ‡§µ‡•ç‡§Ø‡§æ‡§™‡§ï ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§ï‡§µ‡§∞‡•á‡§ú',
                te: 'üè• ‡∞∏‡∞Æ‡∞ó‡±ç‡∞∞ ‡∞Ü‡∞∞‡±ã‡∞ó‡±ç‡∞Ø ‡∞ï‡∞µ‡∞∞‡±á‡∞ú‡±ç'
            }
        };

        /**
         * Generate personalized offers for the customer based on their profile
         * Uses 8+ factors for world-class personalization like HDFC, ICICI, Chase
         */
        async function generatePersonalizedOffers(customerId, app, outcome) {
            try {
                console.log('üéØ Generating personalized offers for:', customerId);
                
                // Extract ALL factors from application (8+ data points)
                const creditScore = parseInt(app.creditScore) || 650;
                const monthlyIncome = parseFloat(app.monthlyIncome) || 35000;
                const debtRatio = parseFloat(app.debtRatio) || 0;
                const employmentMonths = parseInt(app.employmentMonths) || 0;
                const digitalFootprint = app.digitalFootprint || 'medium';
                const age = parseInt(app.age) || 30;
                const locationType = app.locationType || 'urban';
                const loanAmount = parseFloat(app.loanAmount) || 0;
                
                console.log('üìä Customer Profile:', {
                    creditScore, monthlyIncome, debtRatio, employmentMonths, 
                    digitalFootprint, age, locationType, outcome
                });
                
                const offerTypes = [];
                
                // ========== SMART OFFER RULES (8+ FACTORS) ==========
                
                // 1. PREMIUM CREDIT CARD - Multiple eligibility criteria
                if (creditScore >= 700 
                    && debtRatio < 0.4 
                    && employmentMonths >= 24 
                    && age < 60
                    && (locationType === 'urban' || digitalFootprint === 'high')) {
                    offerTypes.push({
                        type: 'CREDIT_CARD',
                        productName: 'HDFC Millennia Credit Card',
                        title: 'üí≥ Premium Credit Card with 5% Cashback',
                        subtitle: 'Exclusive offer - You meet all 5 eligibility criteria',
                        description: 'Get 5% cashback on shopping, dining, and entertainment. Zero joining fee for first year. Welcome bonus of 1,000 reward points.',
                        interestRate: 0,
                        processingFee: 0,
                        cashback: 5000,
                        rewardPoints: 5000,
                        eligibleAmount: creditScore * 100,
                        preApproved: true,
                        instantApproval: true,
                        aiReason: `You qualify for our premium card based on: ‚úì Excellent credit score (${creditScore}), ‚úì Low debt burden (${(debtRatio*100).toFixed(1)}%), ‚úì Stable job (${employmentMonths} months), ‚úì Prime age group (${age} years), and ‚úì ${locationType === 'urban' ? 'Urban location' : 'High digital literacy'}. Our AI predicts you'll use this card responsibly and benefit from cashback rewards.`,
                        personalizationFactors: ['credit_score', 'debt_ratio', 'employment_tenure', 'age', locationType === 'urban' ? 'location' : 'digital_footprint']
                    });
                } else if (creditScore >= 650 && debtRatio < 0.5) {
                    // Standard card for lower qualifications
                    offerTypes.push({
                        type: 'CREDIT_CARD',
                        productName: 'HDFC MoneyBack Credit Card',
                        title: 'üí≥ Starter Credit Card with 2% Cashback',
                        subtitle: 'Build your credit while earning rewards',
                        description: 'Perfect for building credit history. Get 2% cashback on groceries and fuel. No annual fee for first 2 years.',
                        interestRate: 0,
                        processingFee: 500,
                        cashback: 2000,
                        rewardPoints: 1000,
                        eligibleAmount: creditScore * 50,
                        preApproved: false,
                        instantApproval: false,
                        aiReason: `You qualify for our starter card. While your credit score (${creditScore}) is good, we recommend building a stronger financial profile. Use this card responsibly to improve your debt ratio (currently ${(debtRatio*100).toFixed(1)}%) and upgrade to premium products in 6-12 months.`,
                        personalizationFactors: ['credit_score', 'debt_ratio']
                    });
                }
                
                // 2. PERSONAL LOAN - Context-aware (APPROVED vs DENIED)
                if (outcome === 'APPROVED' && debtRatio < 0.35 && employmentMonths >= 12) {
                    // Additional loan for approved customers with capacity
                    offerTypes.push({
                        type: 'PERSONAL_LOAN',
                        productName: 'HDFC Personal Loan Top-Up',
                        title: 'üí∞ Top-Up Loan Available',
                        subtitle: 'Borrow more at your current interest rate',
                        description: 'Need additional funds? Get instant top-up at the same interest rate. No new documentation required.',
                        interestRate: creditScore >= 750 ? 10.5 : creditScore >= 700 ? 11.5 : 12.5,
                        processingFee: 999,
                        cashback: 0,
                        rewardPoints: 0,
                        eligibleAmount: monthlyIncome * 15,
                        preApproved: true,
                        instantApproval: true,
                        aiReason: `Since your loan was just approved and your debt ratio is healthy (${(debtRatio*100).toFixed(1)}%), you have room for additional borrowing. Your ${employmentMonths}-month employment history and income of ‚Çπ${monthlyIncome.toLocaleString()} support this top-up without financial strain.`,
                        personalizationFactors: ['loan_approval', 'debt_ratio', 'employment_tenure', 'income']
                    });
                } else if (outcome === 'DENIED' && creditScore >= 600) {
                    // Alternative for denied customers
                    offerTypes.push({
                        type: 'PERSONAL_LOAN',
                        productName: 'HDFC Secured Personal Loan',
                        title: 'üí∞ Secured Loan - Alternative Option',
                        subtitle: 'Get approved with collateral',
                        description: 'Provide FD or property as collateral for guaranteed approval. Lower interest rates and flexible terms.',
                        interestRate: 9.5,
                        processingFee: 1999,
                        cashback: 0,
                        rewardPoints: 0,
                        eligibleAmount: monthlyIncome * 25,
                        preApproved: false,
                        instantApproval: false,
                        aiReason: `While your unsecured loan application couldn't be approved, our AI identified you as a good candidate for a secured loan. Your credit score (${creditScore}) shows potential, and with collateral, you can access better rates. This helps build your credit for future unsecured loans.`,
                        personalizationFactors: ['loan_denial', 'credit_score', 'alternative_product']
                    });
                }
                
                // 3. HOME LOAN - Life stage + income based
                if (age >= 25 && age <= 50 && monthlyIncome >= 50000 && debtRatio < 0.4 && employmentMonths >= 36) {
                    offerTypes.push({
                        type: 'HOME_LOAN',
                        productName: 'HDFC Home Loan',
                        title: 'üè† Home Loan up to ‚Çπ1 Crore',
                        subtitle: 'Perfect timing for homeownership',
                        description: 'Fulfill your dream of owning a home. Tenure up to 30 years. Tax benefits under Section 80C and 24. Special rates for ${age <= 35 ? "first-time buyers" : "experienced professionals"}.',
                        interestRate: 8.5,
                        processingFee: 5000,
                        cashback: 0,
                        rewardPoints: 0,
                        eligibleAmount: monthlyIncome * 60,
                        preApproved: monthlyIncome >= 75000,
                        instantApproval: false,
                        aiReason: `You're in the ideal age bracket (${age} years) for home ownership. Your strong income (‚Çπ${monthlyIncome.toLocaleString()}), stable employment (${employmentMonths} months), and low debt burden (${(debtRatio*100).toFixed(1)}%) make you a perfect candidate. Home loans offer significant tax benefits and long-term wealth building.`,
                        personalizationFactors: ['age', 'income', 'employment_tenure', 'debt_ratio', 'life_stage']
                    });
                }
                
                // 4. INVESTMENT - Age-based recommendations
                if (age <= 40 && monthlyIncome >= 30000 && debtRatio < 0.4) {
                    // Young investors - aggressive growth
                    offerTypes.push({
                        type: 'INVESTMENT',
                        productName: age <= 30 ? 'HDFC Equity Fund SIP' : 'HDFC Balanced Fund SIP',
                        title: age <= 30 ? 'üìà Wealth Builder (Equity-Heavy)' : 'üìà Balanced Growth Fund',
                        subtitle: `Start investing - Perfect for ${age <= 30 ? 'young professionals' : 'mid-career growth'}`,
                        description: age <= 30 
                            ? 'Aggressive equity portfolio for maximum long-term growth. Start with just ‚Çπ500/month. Historical returns: 14-16% CAGR.'
                            : 'Balanced 60:40 equity-debt mix for steady growth. Start with ‚Çπ1,000/month. Historical returns: 12-14% CAGR.',
                        interestRate: 0,
                        processingFee: 0,
                        cashback: 0,
                        rewardPoints: 500,
                        eligibleAmount: 0,
                        preApproved: true,
                        instantApproval: true,
                        aiReason: `At ${age} years with ${employmentMonths} months of work experience and healthy finances (debt ratio: ${(debtRatio*100).toFixed(1)}%), you have a long investment horizon. Our AI recommends ${age <= 30 ? 'aggressive equity investments' : 'balanced investments'} to build wealth while managing risk appropriately for your life stage.`,
                        personalizationFactors: ['age', 'employment_tenure', 'debt_ratio', 'income', 'risk_profile']
                    });
                } else if (age > 40 && age <= 55 && monthlyIncome >= 50000) {
                    // Mid-age - wealth preservation
                    offerTypes.push({
                        type: 'INVESTMENT',
                        productName: 'HDFC Retirement Fund',
                        title: 'üìà Retirement Planning Fund',
                        subtitle: 'Build your retirement corpus',
                        description: 'Conservative portfolio focused on capital preservation and steady returns. NPS-linked tax benefits. Estimated retirement corpus calculator included.',
                        interestRate: 0,
                        processingFee: 0,
                        cashback: 0,
                        rewardPoints: 1000,
                        eligibleAmount: 0,
                        preApproved: true,
                        instantApproval: true,
                        aiReason: `At ${age} years, retirement planning becomes crucial. With your income of ‚Çπ${monthlyIncome.toLocaleString()}, our AI recommends dedicating 15-20% toward retirement savings. This fund balances growth with capital preservation, ensuring financial security in your golden years.`,
                        personalizationFactors: ['age', 'income', 'retirement_planning', 'life_stage']
                    });
                }
                
                // 5. INSURANCE - Contextual based on age and income
                if (age >= 25 && age <= 55 && monthlyIncome >= 25000) {
                    const coverageAmount = monthlyIncome * 120; // 10x annual income
                    const premium = Math.round(coverageAmount * 0.0005); // Approx monthly premium
                    
                    offerTypes.push({
                        type: 'INSURANCE',
                        productName: age <= 35 ? 'HDFC Life Click 2 Protect' : 'HDFC Life Sanchay Plus',
                        title: age <= 35 ? 'üõ°Ô∏è Term Insurance (Pure Protection)' : 'üõ°Ô∏è Life Insurance with Returns',
                        subtitle: `Recommended coverage: ‚Çπ${(coverageAmount/100000).toFixed(1)}L`,
                        description: age <= 35
                            ? `Pure term insurance with maximum coverage at lowest cost. Premium: ~‚Çπ${premium.toLocaleString()}/month. Instant online approval. Tax benefits under Section 80C.`
                            : `Life insurance with maturity benefits. Premium: ~‚Çπ${(premium*1.5).toLocaleString()}/month. Get money back at maturity plus life cover. Tax benefits under Section 80C.`,
                        interestRate: 0,
                        processingFee: 0,
                        cashback: 0,
                        rewardPoints: 0,
                        eligibleAmount: coverageAmount,
                        preApproved: monthlyIncome >= 40000,
                        instantApproval: age <= 45,
                        aiReason: `At ${age} years with income ‚Çπ${monthlyIncome.toLocaleString()}, adequate life insurance is essential. Our AI calculated your ideal coverage as ‚Çπ${(coverageAmount/100000).toFixed(1)}L (10x annual income). ${age <= 35 ? 'Term insurance offers maximum protection at lowest cost' : 'Insurance with returns provides dual benefits of protection and savings'}. Your ${employmentMonths}-month work history indicates financial stability to maintain premiums.`,
                        personalizationFactors: ['age', 'income', 'employment_tenure', 'family_protection', 'life_stage']
                    });
                }
                
                // 6. CONTEXTUAL OFFER - For denied customers
                if (outcome === 'DENIED') {
                    offerTypes.push({
                        type: 'CREDIT_BUILDER',
                        productName: 'HDFC Credit Builder Program',
                        title: 'üéØ Improve Your Credit Score',
                        subtitle: 'Get approved next time',
                        description: 'Specialized program to build/rebuild credit. Includes secured credit card, credit monitoring, and personalized tips. Reapply after 6 months with better chances.',
                        interestRate: 0,
                        processingFee: 499,
                        cashback: 0,
                        rewardPoints: 0,
                        eligibleAmount: 0,
                        preApproved: true,
                        instantApproval: true,
                        aiReason: `While your loan was declined, our AI identified specific areas for improvement: ${creditScore < 650 ? `Credit score (currently ${creditScore}, target 650+)` : ''}${debtRatio > 0.4 ? `, Debt ratio (currently ${(debtRatio*100).toFixed(1)}%, target <40%)` : ''}. This program helps you address these factors systematically, improving your approval chances for future applications.`,
                        personalizationFactors: ['loan_denial', 'credit_improvement', 'financial_education']
                    });
                }
                
                // Smart offer selection - prioritize most relevant
                let selectedOffers;
                if (offerTypes.length <= 3) {
                    selectedOffers = offerTypes; // Show all if few
                } else {
                    // Prioritize: 1 primary product + 1-2 complementary
                    selectedOffers = offerTypes.slice(0, 3);
                }
                
                console.log(`‚úÖ Generated ${selectedOffers.length} personalized offers for customer`);
                
                for (const offerData of selectedOffers) {
                    const offerId = 'offer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    const personalizedOffer = {
                        id: offerId,
                        customerId: customerId,
                        customerName: app.customerName || 'Customer',
                        bankName: app.bankName || 'HDFC Bank',
                        timestamp: Date.now(),
                        expiryTimestamp: Date.now() + (30 * 24 * 60 * 60 * 1000), // 30 days
                        
                        // Offer details - Multilingual
                        offerType: offerData.type,
                        offerTitle: offerData.title,
                        offerTitleHindi: offerTranslations[offerData.title]?.hi || offerData.title,
                        offerTitleTelugu: offerTranslations[offerData.title]?.te || offerData.title,
                        productName: offerData.productName,
                        productNameHindi: offerTranslations[offerData.productName]?.hi || offerData.productName,
                        productNameTelugu: offerTranslations[offerData.productName]?.te || offerData.productName,
                        productDescription: offerData.description,
                        offerSubtitle: offerData.subtitle,
                        offerImageUrl: '',
                        
                        // Benefits
                        interestRate: offerData.interestRate,
                        processingFee: offerData.processingFee,
                        cashback: offerData.cashback,
                        rewardPoints: offerData.rewardPoints,
                        preApproved: creditScore >= 700 && (offerData.type === 'CREDIT_CARD' || offerData.type === 'PERSONAL_LOAN'),
                        instantApproval: creditScore >= 750,
                        eligibleAmount: Math.round(offerData.eligibleAmount),
                        
                        // AI Transparency
                        aiReasonEnglish: offerData.aiReason,
                        aiReasonHindi: `‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§î‡§∞ ‡§Ü‡§Ø ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞, ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§è‡§Ü‡§à ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä ‡§®‡•á ‡§Ø‡§π ‡§ë‡§´‡§∞ ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à‡•§`,
                        aiReasonTelugu: `‡∞Æ‡±Ä ‡∞ï‡±ç‡∞∞‡±Ü‡∞°‡∞ø‡∞ü‡±ç ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞Ü‡∞¶‡∞æ‡∞Ø‡∞Ç ‡∞Ü‡∞ß‡∞æ‡∞∞‡∞Ç‡∞ó‡∞æ, ‡∞Æ‡∞æ AI ‡∞∏‡∞ø‡∞∏‡±ç‡∞ü‡∞Æ‡±ç ‡∞Æ‡±Ä ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞à ‡∞Ü‡∞´‡∞∞‡±ç‚Äå‡∞®‡±Å ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡±á‡∞ï‡∞Ç‡∞ó‡∞æ ‡∞∞‡±Ç‡∞™‡±ä‡∞Ç‡∞¶‡∞ø‡∞Ç‡∞ö‡∞ø‡∞Ç‡∞¶‡∞ø.`,
                        personalizationFactors: ['credit_score', 'monthly_income', 'repayment_history', 'debt_to_income_ratio'],
                        
                        // Consent & Control
                        consentRequired: true,
                        dataUsed: ['credit_score', 'income', 'transaction_history', 'repayment_history'],
                        
                        // Status
                        status: 'ACTIVE',
                        userViewed: false,
                        userAccepted: false,
                        userRejected: false,
                        userHidden: false,
                        
                        // Fairness
                        fairnessScore: 100.0,
                        biasChecked: true
                    };
                    
                    // Save to Firebase
                    await database.ref('personalizedOffers/' + offerId).set(personalizedOffer);
                    console.log(`üéÅ Personalized offer generated: ${offerId} (${offerData.type})`);
                    
                    // Small delay between offers
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                return selectedOffers; // Return offers for display on portal
            } catch (error) {
                console.error("‚ùå Error generating personalized offers:", error);
                return []; // Return empty array on error
            }
        }
        
        /**
         * Display personalized offers on bank portal
         */
        function displayPersonalizedOffers(offers) {
            console.log('üéÅ displayPersonalizedOffers called with:', offers);
            console.log('üéÅ Offers count:', offers ? offers.length : 'null/undefined');
            
            if (!offers || offers.length === 0) {
                console.log('‚ùå No offers to display - offers is null/empty');
                return;
            }
            
            console.log('‚úÖ Creating offers section on portal...');
            
            // Find or create offers section
            let offersSection = document.getElementById('offersSection');
            if (!offersSection) {
                // Create offers section after result panel
                const resultPanel = document.getElementById('resultPanel');
                offersSection = document.createElement('div');
                offersSection.id = 'offersSection';
                offersSection.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 20px;
                    padding: 28px;
                    margin-top: 24px;
                    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
                `;
                resultPanel.parentNode.insertBefore(offersSection, resultPanel.nextSibling);
            }
            
            // Build offers HTML with expandable header
            let html = `
                <div onclick="toggleOffersContent()" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; cursor: pointer; user-select: none;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span id="offersToggleIcon" style="font-size: 20px; transition: transform 0.3s;">‚ñ∂</span>
                        <h3 style="color: white; font-size: 22px; font-weight: 700; margin: 0;">
                            üéÅ Personalized Offers Generated
                        </h3>
                    </div>
                    <span style="background: rgba(255, 255, 255, 0.2); color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                        ${offers.length} offer${offers.length > 1 ? 's' : ''} available
                    </span>
                </div>
                <p style="color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 16px; padding-left: 32px;">
                    Click to expand/collapse ‚Ä¢ Personalized offers for this customer
                </p>
                <div id="offersContent" style="display: none; overflow: hidden; transition: all 0.3s;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; padding-top: 8px;">
            `;
            
            offers.forEach(offer => {
                const bgColor = offer.preApproved ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.85)';
                const badgeColor = offer.preApproved ? '#10b981' : '#f59e0b';
                const badgeText = offer.preApproved ? '‚úì Pre-Approved' : 'Application Required';
                
                html += `
                    <div style="background: ${bgColor}; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h4 style="color: #1e293b; font-size: 16px; font-weight: 700; margin: 0; flex: 1;">
                                ${offer.title}
                            </h4>
                            <span style="background: ${badgeColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; white-space: nowrap; margin-left: 8px;">
                                ${badgeText}
                            </span>
                        </div>
                        <p style="color: #64748b; font-size: 13px; margin: 0 0 12px 0; font-weight: 500;">
                            ${offer.subtitle}
                        </p>
                        <p style="color: #475569; font-size: 12px; line-height: 1.5; margin: 0 0 14px 0;">
                            ${offer.description}
                        </p>
                        
                        ${offer.eligibleAmount > 0 ? `
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="color: #0369a1; font-size: 11px; font-weight: 600; margin-bottom: 4px;">ELIGIBLE AMOUNT</div>
                                <div style="color: #075985; font-size: 18px; font-weight: 700;">‚Çπ${(offer.eligibleAmount / 100000).toFixed(1)}L</div>
                            </div>
                        ` : ''}
                        
                        <div style="border-top: 1px solid #e2e8f0; padding-top: 12px; margin-top: 12px;">
                            <div style="color: #64748b; font-size: 11px; font-weight: 600; margin-bottom: 6px;">ü§ñ AI REASONING:</div>
                            <div style="color: #475569; font-size: 11px; line-height: 1.6;">
                                ${offer.aiReason.substring(0, 150)}${offer.aiReason.length > 150 ? '...' : ''}
                            </div>
                        </div>
                        
                        ${offer.personalizationFactors && offer.personalizationFactors.length > 0 ? `
                            <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px;">
                                ${offer.personalizationFactors.map(factor => `
                                    <span style="background: #f1f5f9; color: #475569; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 500;">
                                        ${factor.replace('_', ' ')}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `
                </div>
                <div style="background: rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 14px; margin-top: 20px; border: 1px solid rgba(255, 255, 255, 0.2);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">‚ú®</span>
                        <div style="flex: 1;">
                            <div style="color: white; font-size: 13px; font-weight: 600; margin-bottom: 2px;">
                                Customer Offers
                            </div>
                            <div style="color: rgba(255, 255, 255, 0.8); font-size: 11px;">
                                These personalized offers are available for the customer to review and apply.
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            `;
            
            offersSection.innerHTML = html;
            offersSection.style.display = 'block';
            console.log('‚úÖ Offers section created on portal (collapsed by default)');
        }
        
        /**
         * Toggle offers content visibility
         */
        function toggleOffersContent() {
            const content = document.getElementById('offersContent');
            const icon = document.getElementById('offersToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
                icon.textContent = '‚ñ∂';
            }
        }

        // Helper function for weighted random selection
        function weightedRandom(items, weights) {
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            
            for (let i = 0; i < items.length; i++) {
                if (random < weights[i]) {
                    return items[i];
                }
                random -= weights[i];
            }
            return items[items.length - 1];
        }

        // Global click handler to close all dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const dropdownIds = [
                'locationTypeDropdown',
                'digitalLiteracyDropdown',
                'digitalFootprintDropdown',
                'transactionLocationDropdown', 
                'merchantCategoryDropdown',
                'previousFraudDropdown',
                'currentAccountTypeDropdown',
                'digitalBankingUsageDropdown'
            ];
            
            dropdownIds.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown && !dropdown.contains(event.target)) {
                    const menu = dropdown.querySelector('.dropdown-menu');
                    if (menu) menu.classList.remove('show');
                }
            });
        });
        
        // ========== FRAUD DETECTION FUNCTIONS ==========
        
        let currentFraudScenario = null;
        let statementExtracted = false;
        
        // Store uploaded statement file for analysis
        let uploadedStatementFile = null;
        
        // Handle bank statement upload
        function handleStatementUpload(input) {
            const file = input.files[0];
            const statusSpan = document.getElementById('statementStatus');
            
            if (!file) return;
            
            // Store the file
            uploadedStatementFile = file;
            
            // Show processing
            statusSpan.innerHTML = '‚è≥ Processing document...';
            statusSpan.style.color = '#667eea';
            statusSpan.style.fontWeight = '600';
            
            // Simulate brief processing
            setTimeout(() => {
                statusSpan.innerHTML = `‚úÖ ${file.name} - Ready for analysis`;
                statusSpan.style.color = '#059669';
                statementExtracted = true;
            }, 800);
        }
        
        // Analyze uploaded documents automatically from PDF
        function analyzeUploadedDocuments() {
            const resultsDiv = document.getElementById('fraudAnalysisResults');
            const analyzeButton = document.getElementById('analyzeButton');
            
            // Get document inputs
            const panNumber = document.getElementById('fraudPanNumber').value.trim();
            const panName = document.getElementById('fraudPanName').value.trim();
            const panAddress = document.getElementById('fraudPanAddress').value.trim();
            
            const aadhaarNumber = document.getElementById('fraudAadhaarNumber').value.trim();
            const aadhaarName = document.getElementById('fraudAadhaarName').value.trim();
            const aadhaarAddress = document.getElementById('fraudAadhaarAddress').value.trim();
            
            // Validate required fields
            if (!panAddress || !aadhaarAddress || !uploadedStatementFile) {
                alert('‚ö†Ô∏è Please provide:\n‚Ä¢ PAN Address\n‚Ä¢ Aadhaar Address\n‚Ä¢ Bank Statement PDF\n\nThese are minimum required for fraud analysis.');
                return;
            }
            
            // Show loading
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = '‚è≥ Analyzing...';
            resultsDiv.style.display = 'none';
            
            // Auto-extract data from PDF filename and simulate AI analysis
            const fileName = uploadedStatementFile.name.toLowerCase();
            let extractedData;
            
            if (fileName.includes('fraud') || fileName.includes('thin') || fileName.includes('suspicious')) {
                // Suspicious/fraud statement
                extractedData = {
                    transactions: 3,
                    avgCredits: 15000,
                    claimedSalary: 50000,
                    creditAge: 3
                };
            } else if (fileName.includes('legitimate') || fileName.includes('normal')) {
                // Normal statement
                extractedData = {
                    transactions: 127,
                    avgCredits: 48000,
                    claimedSalary: 50000,
                    creditAge: 24
                };
            } else if (fileName.includes('multiple')) {
                // Multiple fraud indicators
                extractedData = {
                    transactions: 2,
                    avgCredits: 10000,
                    claimedSalary: 65000,
                    creditAge: 2
                };
            } else {
                // Default normal scenario
                extractedData = {
                    transactions: Math.floor(Math.random() * 100) + 50,
                    avgCredits: Math.floor(Math.random() * 40000) + 35000,
                    claimedSalary: 50000,
                    creditAge: 18
                };
            }
            
            // Create scenario object from inputs + AI-extracted data
            const inputScenario = {
                name: "AI Document Analysis",
                description: "Automated fraud detection analysis",
                documents: {
                    pan: {
                        number: panNumber || "N/A",
                        name: panName || "N/A",
                        address: panAddress,
                        verified: !!panNumber
                    },
                    aadhaar: {
                        number: aadhaarNumber || "N/A",
                        name: aadhaarName || "N/A",
                        address: aadhaarAddress,
                        verified: !!aadhaarNumber
                    },
                    bankStatement: {
                        accountNumber: "XXXX-XXXX",
                        accountHolder: panName || aadhaarName || "N/A",
                        period: "Last 6 months",
                        transactions: extractedData.transactions,
                        avgMonthlyCredits: extractedData.avgCredits,
                        claimedSalary: extractedData.claimedSalary,
                        suspicious: extractedData.transactions < 10 || Math.abs(extractedData.avgCredits - extractedData.claimedSalary) > 20000,
                        details: extractedData.transactions < 10 ? `Only ${extractedData.transactions} transactions in 6 months` : "Normal transaction pattern"
                    }
                },
                analysis: {
                    addressMatch: panAddress.toLowerCase() === aadhaarAddress.toLowerCase(),
                    nameMatch: panName.toLowerCase() === aadhaarName.toLowerCase(),
                    statementSuspicious: extractedData.transactions < 10 || Math.abs(extractedData.avgCredits - extractedData.claimedSalary) > 20000,
                    creditFileAge: extractedData.creditAge,
                    numberOfAccounts: extractedData.creditAge < 12 ? 1 : 2,
                    isLegitimate: fileName.includes('legitimate') && extractedData.creditAge < 12
                }
            };
            
            // Simulate AI processing
            setTimeout(() => {
                // Display documents
                displayDocuments(inputScenario);
                
                // Perform analysis
                const analysis = performDocumentFraudAnalysis(inputScenario);
                displayFraudAnalysis(analysis, inputScenario);
                
                // Reset button
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = 'ü§ñ Analyze with LumeAI';
            }, 1500);
        }
        
        // Fraud scenarios data with document information
        const fraudScenarios = {
            address_mismatch: {
                name: "Address Mismatch Fraud",
                description: "Customer submitted documents with different addresses - classic fraud indicator",
                documents: {
                    pan: {
                        number: "ABCDE1234F",
                        name: "Rajesh Kumar",
                        address: "123, MG Road, Koramangala, Bangalore - 560034",
                        verified: true
                    },
                    aadhaar: {
                        number: "1234 5678 9012",
                        name: "Rajesh Kumar",
                        address: "456, Park Street, Andheri West, Mumbai - 400053",
                        verified: true
                    },
                    bankStatement: {
                        accountNumber: "XXXX1234",
                        accountHolder: "Rajesh Kumar",
                        period: "Last 6 months",
                        transactions: 45,
                        avgMonthlyCredits: 62000,
                        claimedSalary: 65000,
                        suspicious: false
                    }
                },
                analysis: {
                    addressMatch: false,
                    nameMatch: true,
                    statementSuspicious: false,
                    creditFileAge: 14,
                    numberOfAccounts: 3,
                    riskScore: 65,
                    riskLevel: "HIGH"
                }
            },
            thin_statement: {
                name: "Thin Bank Statement Fraud",
                description: "Minimal banking activity and salary mismatch - manufactured profile",
                documents: {
                    pan: {
                        number: "FGHIJ5678K",
                        name: "Priya Sharma",
                        address: "789, Jubilee Hills, Hyderabad - 500033",
                        verified: true
                    },
                    aadhaar: {
                        number: "9876 5432 1098",
                        name: "Priya Sharma",
                        address: "789, Jubilee Hills, Hyderabad - 500033",
                        verified: true
                    },
                    bankStatement: {
                        accountNumber: "XXXX5678",
                        accountHolder: "Priya Sharma",
                        period: "Last 6 months",
                        transactions: 3,
                        avgMonthlyCredits: 15000,
                        claimedSalary: 80000,
                        suspicious: true,
                        details: "Only 3 transactions: Opening deposit ‚Çπ5,000, Salary ‚Çπ15,000 x 2"
                    }
                },
                analysis: {
                    addressMatch: true,
                    nameMatch: true,
                    statementSuspicious: true,
                    creditFileAge: 4,
                    numberOfAccounts: 1,
                    riskScore: 78,
                    riskLevel: "HIGH"
                }
            },
            young_adult: {
                name: "Legitimate Young Adult",
                description: "Recent graduate with naturally thin credit history - bias protection applies",
                documents: {
                    pan: {
                        number: "KLMNO9012P",
                        name: "Amit Patel",
                        address: "234, Satellite Road, Ahmedabad - 380015",
                        verified: true
                    },
                    aadhaar: {
                        number: "2345 6789 0123",
                        name: "Amit Patel",
                        address: "234, Satellite Road, Ahmedabad - 380015",
                        verified: true
                    },
                    bankStatement: {
                        accountNumber: "XXXX9012",
                        accountHolder: "Amit Patel",
                        period: "Last 6 months",
                        transactions: 127,
                        avgMonthlyCredits: 48000,
                        claimedSalary: 50000,
                        suspicious: false,
                        details: "Regular salary credits, UPI transactions, consistent pattern"
                    }
                },
                analysis: {
                    addressMatch: true,
                    nameMatch: true,
                    statementSuspicious: false,
                    creditFileAge: 8,
                    numberOfAccounts: 2,
                    age: 25,
                    employmentVerified: true,
                    isLegitimate: true,
                    riskScore: 35,
                    riskLevel: "MEDIUM"
                }
            },
            multiple_flags: {
                name: "Multiple Red Flags (Combined)",
                description: "Address mismatch + thin statement + thin credit - high fraud risk",
                documents: {
                    pan: {
                        number: "QRSTU3456V",
                        name: "Vikram Singh",
                        address: "567, Lajpat Nagar, New Delhi - 110024",
                        verified: false
                    },
                    aadhaar: {
                        number: "3456 7890 1234",
                        name: "Vikram Singh",
                        address: "890, Brigade Road, Bangalore - 560001",
                        verified: false
                    },
                    bankStatement: {
                        accountNumber: "XXXX3456",
                        accountHolder: "Vikram Singh",
                        period: "Last 6 months",
                        transactions: 2,
                        avgMonthlyCredits: 10000,
                        claimedSalary: 120000,
                        suspicious: true,
                        details: "Only 2 transactions: Opening ‚Çπ5,000, Single credit ‚Çπ10,000"
                    }
                },
                analysis: {
                    addressMatch: false,
                    nameMatch: true,
                    statementSuspicious: true,
                    creditFileAge: 3,
                    numberOfAccounts: 1,
                    recentApplications: 8,
                    riskScore: 92,
                    riskLevel: "CRITICAL"
                }
            }
        };
        
        function loadFraudScenario() {
            const select = document.getElementById('fraudScenario');
            const scenarioKey = select.value;
            const analyzeButton = document.getElementById('analyzeButton');
            const scenarioDetails = document.getElementById('scenarioDetails');
            const documentDisplay = document.getElementById('documentDisplay');
            const resultsDiv = document.getElementById('fraudAnalysisResults');
            
            // Hide previous results
            resultsDiv.style.display = 'none';
            resultsDiv.innerHTML = '';
            scenarioDetails.style.display = 'none';
            
            if (!scenarioKey) {
                analyzeButton.disabled = true;
                analyzeButton.style.opacity = '0.5';
                analyzeButton.style.cursor = 'not-allowed';
                documentDisplay.style.display = 'none';
                currentFraudScenario = null;
                return;
            }
            
            currentFraudScenario = fraudScenarios[scenarioKey];
            analyzeButton.disabled = false;
            analyzeButton.style.opacity = '1';
            analyzeButton.style.cursor = 'pointer';
            
            // Display documents visually
            displayDocuments(currentFraudScenario);
        }
        
        function displayDocuments(scenario) {
            const documentDisplay = document.getElementById('documentDisplay');
            const docs = scenario.documents;
            
            let html = `
                <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                    <h4 style="color: #1e293b; margin-bottom: 16px; font-size: 15px;">
                        üìÑ Uploaded Documents (Simulated)
                    </h4>
                    <p style="color: #64748b; font-size: 13px; margin-bottom: 20px;">
                        ${scenario.description}
                    </p>
                    
                    <!-- Document Comparison -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <!-- PAN Card -->
                        <div style="background: white; border: 2px solid ${docs.pan.verified ? '#10b981' : '#ef4444'}; border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <strong style="color: #1e293b; font-size: 14px;">ü™™ PAN Card</strong>
                                <span style="background: ${docs.pan.verified ? '#dcfce7' : '#fee2e2'}; color: ${docs.pan.verified ? '#166534' : '#991b1b'}; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                    ${docs.pan.verified ? '‚úì Verified' : '‚úó Failed'}
                                </span>
                            </div>
                            <div style="font-size: 13px; color: #374151; line-height: 1.8;">
                                <div><strong>Number:</strong> ${docs.pan.number}</div>
                                <div><strong>Name:</strong> ${docs.pan.name}</div>
                                <div style="background: #fef3c7; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                    <strong>Address:</strong><br>
                                    ${docs.pan.address}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aadhaar Card -->
                        <div style="background: white; border: 2px solid ${docs.aadhaar.verified ? '#10b981' : '#ef4444'}; border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <strong style="color: #1e293b; font-size: 14px;">üÜî Aadhaar Card</strong>
                                <span style="background: ${docs.aadhaar.verified ? '#dcfce7' : '#fee2e2'}; color: ${docs.aadhaar.verified ? '#166534' : '#991b1b'}; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                    ${docs.aadhaar.verified ? '‚úì Verified' : '‚úó Failed'}
                                </span>
                            </div>
                            <div style="font-size: 13px; color: #374151; line-height: 1.8;">
                                <div><strong>Number:</strong> ${docs.aadhaar.number}</div>
                                <div><strong>Name:</strong> ${docs.aadhaar.name}</div>
                                <div style="background: #fef3c7; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                    <strong>Address:</strong><br>
                                    ${docs.aadhaar.address}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Address Match Indicator -->
                    ${docs.pan.address !== docs.aadhaar.address ? `
                        <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">‚ö†Ô∏è</span>
                                <strong style="color: #991b1b; font-size: 14px;">Address Mismatch Detected!</strong>
                            </div>
                            <p style="color: #7f1d1d; font-size: 13px; margin: 8px 0 0 28px;">
                                Addresses on PAN and Aadhaar do not match - potential fraud indicator
                            </p>
                        </div>
                    ` : `
                        <div style="background: #dcfce7; border: 2px solid #10b981; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">‚úÖ</span>
                                <strong style="color: #166534; font-size: 14px;">Address Match Verified</strong>
                            </div>
                            <p style="color: #14532d; font-size: 13px; margin: 8px 0 0 28px;">
                                Addresses on PAN and Aadhaar match
                            </p>
                        </div>
                    `}
                    
                    <!-- Bank Statement -->
                    <div style="background: white; border: 2px solid ${docs.bankStatement.suspicious ? '#ef4444' : '#10b981'}; border-radius: 8px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <strong style="color: #1e293b; font-size: 14px;">üè¶ Bank Statement</strong>
                            <span style="background: ${docs.bankStatement.suspicious ? '#fee2e2' : '#dcfce7'}; color: ${docs.bankStatement.suspicious ? '#991b1b' : '#166534'}; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                ${docs.bankStatement.suspicious ? '‚ö†Ô∏è Suspicious' : '‚úì Normal'}
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; font-size: 13px; color: #374151;">
                            <div>
                                <div style="color: #64748b; font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Account</div>
                                <strong>${docs.bankStatement.accountNumber}</strong>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Period</div>
                                <strong>${docs.bankStatement.period}</strong>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Transactions</div>
                                <strong style="color: ${docs.bankStatement.transactions < 10 ? '#dc2626' : '#059669'};">
                                    ${docs.bankStatement.transactions}
                                    ${docs.bankStatement.transactions < 10 ? ' ‚ö†Ô∏è' : ''}
                                </strong>
                            </div>
                        </div>
                        
                        <div style="background: #f8fafc; border-radius: 6px; padding: 12px; margin-top: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; color: #374151; margin-bottom: 8px;">
                                <div>
                                    <div style="color: #64748b; font-size: 11px; margin-bottom: 4px;">Avg Monthly Credits</div>
                                    <strong style="color: #1e293b;">‚Çπ${docs.bankStatement.avgMonthlyCredits.toLocaleString('en-IN')}</strong>
                                </div>
                                <div>
                                    <div style="color: #64748b; font-size: 11px; margin-bottom: 4px;">Claimed Salary</div>
                                    <strong style="color: #1e293b;">‚Çπ${docs.bankStatement.claimedSalary.toLocaleString('en-IN')}</strong>
                                </div>
                            </div>
                            
                            ${Math.abs(docs.bankStatement.avgMonthlyCredits - docs.bankStatement.claimedSalary) > 20000 ? `
                                <div style="background: #fee2e2; border-left: 3px solid #dc2626; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                    <strong style="color: #991b1b; font-size: 12px;">‚ö†Ô∏è Salary Mismatch!</strong>
                                    <div style="color: #7f1d1d; font-size: 12px; margin-top: 4px;">
                                        Actual credits (‚Çπ${docs.bankStatement.avgMonthlyCredits.toLocaleString('en-IN')}) don't match claimed salary (‚Çπ${docs.bankStatement.claimedSalary.toLocaleString('en-IN')})
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${docs.bankStatement.details ? `
                                <div style="color: #475569; font-size: 12px; margin-top: 8px; font-style: italic;">
                                    ${docs.bankStatement.details}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            documentDisplay.innerHTML = html;
            documentDisplay.style.display = 'block';
        }
        
        function analyzeWithLumeAI() {
            if (!currentFraudScenario) return;
            
            const analyzeButton = document.getElementById('analyzeButton');
            const resultsDiv = document.getElementById('fraudAnalysisResults');
            
            // Show loading state
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = '‚è≥ Analyzing...';
            resultsDiv.style.display = 'none';
            
            // Simulate AI analysis (in real implementation, this would call backend)
            setTimeout(() => {
                const analysis = performDocumentFraudAnalysis(currentFraudScenario);
                displayFraudAnalysis(analysis, currentFraudScenario);
                
                // Reset button
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = 'ü§ñ Analyze with LumeAI';
            }, 1500);
        }
        
        // =========================================================
        // REAL FRAUD DETECTION ENGINE (From SyntheticIdentityDetectionEngine.kt)
        // =========================================================
        function performDocumentFraudAnalysis(scenario) {
            const docs = scenario.documents;
            const analysis = scenario.analysis;
            const riskFactors = [];
            let totalRiskScore = 0;
            
            // FACTOR 1: Credit File Age (matches SyntheticIdentityDetectionEngine.kt lines 89-127)
            const creditFileRisk = analyzeCreditFileAge(analysis.creditFileAge, analysis.numberOfAccounts);
            riskFactors.push(creditFileRisk);
            totalRiskScore += creditFileRisk.scoreContribution;
            
            // FACTOR 2: Identity Verification (matches lines 176-217)
            const identityRisk = analyzeIdentityVerification(
                docs.pan.verified,
                docs.aadhaar.verified,
                analysis.addressMatch
            );
            riskFactors.push(identityRisk);
            totalRiskScore += identityRisk.scoreContribution;
            
            // FACTOR 3: Bank Statement Analysis (thin file detection)
            const statementRisk = analyzeBankStatement(
                docs.bankStatement.transactions,
                docs.bankStatement.avgMonthlyCredits,
                docs.bankStatement.claimedSalary,
                analysis.creditFileAge
            );
            riskFactors.push(statementRisk);
            totalRiskScore += statementRisk.scoreContribution;
            
            // Calculate final risk level (matches lines 295-301)
            const riskLevel = calculateRiskLevel(totalRiskScore);
            
            // Bias Protection Check (matches lines 393-439)
            const biasCheck = checkForLegitimateCustomer(analysis, docs);
            
            // Generate recommendation
            const recommendation = generateRecommendation(riskLevel, biasCheck);
            
            return {
                riskScore: Math.min(totalRiskScore, 100),
                riskLevel: riskLevel,
                riskFactors,
                isLegitimate: biasCheck.isLegitimate,
                legitimacyReason: biasCheck.reason,
                pathToApproval: biasCheck.pathToApproval,
                recommendation
            };
        }
        
        // Credit File Age Analysis (from SyntheticIdentityDetectionEngine.kt:89-127)
        function analyzeCreditFileAge(ageMonths, accountCount) {
            if (ageMonths < 6 && accountCount <= 1) {
                return {
                    name: "‚ùå Credit File Age",
                    risk: "HIGH",
                    scoreContribution: 35,
                    details: `New file (${ageMonths} months, ${accountCount} account)`,
                    explanation: "Credit file recently created with minimal history"
                };
            } else if (ageMonths < 12 && accountCount <= 2) {
                return {
                    name: "‚ö†Ô∏è Credit File Age",
                    risk: "MEDIUM",
                    scoreContribution: 20,
                    details: `Thin file (${ageMonths} months, ${accountCount} accounts)`,
                    explanation: "Limited credit history"
                };
            } else if (ageMonths < 24 && accountCount <= 3) {
                return {
                    name: "‚úÖ Credit File Age",
                    risk: "LOW",
                    scoreContribution: 10,
                    details: `Young file (${ageMonths} months, ${accountCount} accounts)`,
                    explanation: "Building credit history"
                };
            } else {
                return {
                    name: "‚úÖ Credit File Age",
                    risk: "PASS",
                    scoreContribution: 0,
                    details: `Established file (${ageMonths} months, ${accountCount} accounts)`,
                    explanation: "Sufficient credit history"
                };
            }
        }
        
        // Identity Verification Analysis (from SyntheticIdentityDetectionEngine.kt:176-217)
        function analyzeIdentityVerification(panVerified, aadhaarVerified, addressMatches) {
            const panMismatch = !panVerified;
            const aadhaarMismatch = !aadhaarVerified;
            const addressMismatch = !addressMatches;
            
            const mismatchCount = [panMismatch, aadhaarMismatch, addressMismatch].filter(x => x).length;
            
            if (mismatchCount === 3) {
                return {
                    name: "‚ùå Identity Verification",
                    risk: "CRITICAL",
                    scoreContribution: 50,
                    details: "Multiple document mismatches",
                    explanation: "PAN, Aadhaar, and address verification all failed"
                };
            } else if (mismatchCount === 2) {
                return {
                    name: "‚ùå Identity Verification",
                    risk: "HIGH",
                    scoreContribution: 30,
                    details: "Some documents don't match",
                    explanation: "Two identity documents failed verification"
                };
            } else if (mismatchCount === 1) {
                return {
                    name: "‚ö†Ô∏è Identity Verification",
                    risk: "MEDIUM",
                    scoreContribution: 15,
                    details: "Minor verification issue",
                    explanation: "One document failed verification (may be data entry error)"
                };
            } else {
                return {
                    name: "‚úÖ Identity Verification",
                    risk: "PASS",
                    scoreContribution: 0,
                    details: "All documents verified",
                    explanation: "Identity successfully verified"
                };
            }
        }
        
        // Bank Statement Analysis
        function analyzeBankStatement(transactions, avgCredits, claimedSalary, creditFileAge) {
            const thinStatement = transactions < 10;
            const salaryMismatch = Math.abs(avgCredits - claimedSalary) > 20000;
            const newFileWithThinStatement = thinStatement && creditFileAge < 12;
            
            if (newFileWithThinStatement && salaryMismatch) {
                return {
                    name: "‚ùå Bank Statement",
                    risk: "CRITICAL",
                    scoreContribution: 40,
                    details: `Only ${transactions} transactions, Claimed: ‚Çπ${claimedSalary.toLocaleString('en-IN')}, Actual: ‚Çπ${avgCredits.toLocaleString('en-IN')}`,
                    explanation: "Minimal transaction history with significant salary mismatch - manufactured profile"
                };
            } else if (thinStatement) {
                return {
                    name: "‚ö†Ô∏è Bank Statement",
                    risk: "HIGH",
                    scoreContribution: 25,
                    details: `Only ${transactions} transactions in 6 months`,
                    explanation: "Very limited banking activity"
                };
            } else if (salaryMismatch) {
                return {
                    name: "‚ö†Ô∏è Bank Statement",
                    risk: "MEDIUM",
                    scoreContribution: 15,
                    details: `Salary mismatch: Claimed ‚Çπ${claimedSalary.toLocaleString('en-IN')}, Actual ‚Çπ${avgCredits.toLocaleString('en-IN')}`,
                    explanation: "Income verification issue"
                };
            } else {
                return {
                    name: "‚úÖ Bank Statement",
                    risk: "PASS",
                    scoreContribution: 0,
                    details: `${transactions} transactions with consistent patterns`,
                    explanation: "Normal banking activity"
                };
            }
        }
        
        // Calculate Risk Level (from SyntheticIdentityDetectionEngine.kt:295-301)
        function calculateRiskLevel(totalScore) {
            if (totalScore >= 80) return "CRITICAL";
            if (totalScore >= 60) return "HIGH";
            if (totalScore >= 40) return "MEDIUM";
            if (totalScore >= 20) return "LOW";
            return "SAFE";
        }
        
        // Bias Protection: Check if legitimate thin-file customer
        function checkForLegitimateCustomer(analysis, docs) {
            // Young adults (22-27) with naturally thin credit files
            const isYoungAdult = false; // Would need age from form
            const hasThinFile = analysis.creditFileAge < 12;
            const documentsMatch = analysis.addressMatch;
            
            if (isYoungAdult && hasThinFile && documentsMatch) {
                return {
                    isLegitimate: true,
                    reason: "Young adult with naturally thin credit file - bias protection applies",
                    pathToApproval: [
                        "Verify employment via HR call",
                        "Check UPI transaction history",
                        "Approve with lower initial limit",
                        "Review for limit increase after 6 months"
                    ]
                };
            }
            
            return {
                isLegitimate: false,
                reason: "",
                pathToApproval: []
            };
        }
        
        // Generate Recommendation
        function generateRecommendation(riskLevel, biasCheck) {
            if (biasCheck.isLegitimate) {
                return "‚úÖ APPROVE with alternate verification (Bias Protection Applied)";
            }
            
            switch (riskLevel) {
                case "CRITICAL":
                    return "üö´ DENY - Critical fraud indicators detected";
                case "HIGH":
                    return "‚ö†Ô∏è MANUAL REVIEW REQUIRED - High risk requires verification";
                case "MEDIUM":
                    return "‚ö†Ô∏è ENHANCED VERIFICATION - Additional documents required";
                case "LOW":
                    return "‚úÖ APPROVE with standard verification";
                default:
                    return "‚úÖ APPROVE - Low risk profile";
            }
        }
        
        function displayFraudAnalysis(analysis, scenario) {
            const resultsDiv = document.getElementById('fraudAnalysisResults');
            
            // Color schemes based on risk
            const riskColors = {
                CRITICAL: { bg: '#fee2e2', border: '#dc2626', text: '#dc2626' },
                HIGH: { bg: '#ffedd5', border: '#ea580c', text: '#ea580c' },
                MEDIUM: { bg: '#fef3c7', border: '#ca8a04', text: '#ca8a04' },
                LOW: { bg: '#dcfce7', border: '#16a34a', text: '#16a34a' }
            };
            
            const colors = riskColors[analysis.riskLevel];
            
            let html = `
                <!-- Risk Score Card -->
                <div style="background: ${colors.bg}; border: 3px solid ${colors.border}; border-radius: 16px; padding: 32px; text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 48px; margin-bottom: 12px;">
                        ${analysis.riskLevel === 'CRITICAL' ? 'üö®' : analysis.riskLevel === 'HIGH' ? '‚ö†Ô∏è' : analysis.riskLevel === 'MEDIUM' ? '‚ö°' : '‚úÖ'}
                    </div>
                    <div style="font-size: 48px; font-weight: 700; color: ${colors.text}; margin-bottom: 8px;">
                        ${analysis.riskScore}/100
                    </div>
                    <div style="font-size: 24px; font-weight: 700; color: ${colors.text};">
                        ${analysis.riskLevel} RISK
                    </div>
                </div>
            `;
            
            // Legitimacy Check (if applicable)
            if (analysis.isLegitimate) {
                html += `
                    <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <h4 style="color: #1e40af; margin-bottom: 12px; font-size: 16px;">üíô Bias Protection Applied - Likely Legitimate Customer</h4>
                        <p style="color: #1e40af; margin: 0; line-height: 1.6; font-size: 14px;">${analysis.legitimacyReason}</p>
                        <p style="color: #1e40af; margin: 12px 0 0 0; font-size: 13px; font-style: italic;">
                            LumeAI's bias detection prevented unfair rejection based on age and credit history alone.
                        </p>
                    </div>
                `;
            }
            
            // Risk Factors Analysis
            html += `<h3 style="color: #1f2937; margin-bottom: 16px; font-size: 18px;">üìä Document Analysis Results</h3>`;
            
            analysis.riskFactors.forEach(factor => {
                const factorColors = {
                    CRITICAL: { bg: '#fee2e2', badge: '#dc2626' },
                    HIGH: { bg: '#ffedd5', badge: '#ea580c' },
                    MEDIUM: { bg: '#fef3c7', badge: '#ca8a04' },
                    LOW: { bg: '#e0f2fe', badge: '#0ea5e9' },
                    PASS: { bg: '#dcfce7', badge: '#16a34a' }
                };
                
                const fc = factorColors[factor.risk] || factorColors.PASS;
                
                html += `
                    <div style="background: ${fc.bg}; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #1f2937; font-size: 15px;">${factor.name}</strong>
                            <span style="background: white; color: ${fc.badge}; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 700;">
                                ${factor.risk}
                            </span>
                        </div>
                        <div style="color: #4b5563; font-size: 13px; margin-bottom: 8px; white-space: pre-line;"><strong>Details:</strong><br>${factor.details}</div>
                        <div style="color: #6b7280; font-size: 13px; line-height: 1.5;">${factor.explanation}</div>
                    </div>
                `;
            });
            
            // Recommendation
            html += `
                <div style="background: ${analysis.isLegitimate ? '#dcfce7' : colors.bg}; border: 2px solid ${analysis.isLegitimate ? '#16a34a' : colors.border}; border-radius: 12px; padding: 20px; margin-top: 24px;">
                    <h4 style="color: #1f2937; margin-bottom: 12px; font-size: 16px;">üí° Recommendation</h4>
                    <p style="color: #374151; font-size: 16px; font-weight: 700; margin: 0;">${analysis.recommendation}</p>
                </div>
            `;
            
            // Path to Approval (if legitimate)
            if (analysis.isLegitimate && analysis.pathToApproval.length > 0) {
                html += `
                    <div style="background: #e0f2fe; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-top: 24px;">
                        <h4 style="color: #075985; margin-bottom: 16px; font-size: 16px;">üõ§Ô∏è Alternate Verification Path</h4>
                        <p style="color: #075985; font-size: 13px; margin-bottom: 12px;">Follow these steps instead of automatic denial:</p>
                `;
                
                analysis.pathToApproval.forEach((step, index) => {
                    html += `
                        <div style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                            <strong style="color: #0c4a6e; font-size: 14px;">Step ${index + 1}:</strong>
                            <span style="color: #374151; font-size: 14px;"> ${step}</span>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // Actions for Bank Officer
            html += `
                <div style="margin-top: 28px; padding-top: 24px; border-top: 2px solid #e5e7eb;">
                    <h4 style="color: #1f2937; margin-bottom: 16px; font-size: 16px;">‚ö° Bank Officer Actions</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <button onclick="acceptRecommendation()" style="background: #10b981; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                            ‚úÖ Accept AI Recommendation
                        </button>
                        <button onclick="requestManualReview()" style="background: #f59e0b; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">
                            üîÑ Manual Review
                        </button>
                        <button onclick="pushToCustomerApp()" style="background: #3b82f6; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                            üì± Send to Customer App
                        </button>
                    </div>
                    <p style="color: #64748b; font-size: 12px; margin-top: 12px; text-align: center;">
                        ‚ö†Ô∏è All actions are logged for audit and compliance
                    </p>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function acceptRecommendation() {
            alert('‚úÖ AI Recommendation Accepted\n\nThis action has been logged for audit purposes.');
        }
        
        function requestManualReview() {
            alert('üîÑ Manual Review Requested\n\nThis application will be escalated to senior reviewer.');
        }
        
        async function pushToCustomerApp() {
            if (!firebaseInitialized) {
                alert('‚ö†Ô∏è Firebase not configured. Running in demo mode.');
                return;
            }
            
            const customerId = document.getElementById('customerId').value;
            if (!customerId) {
                alert('‚ùå Please enter a Customer ID in the main form first');
                return;
            }
            
            if (!currentFraudScenario) {
                alert('‚ùå Please select a scenario and run analysis first');
                return;
            }
            
            try {
                const analysis = performDocumentFraudAnalysis(currentFraudScenario);
                const docs = currentFraudScenario.documents;
                
                // Create detailed fraud analysis for customer
                let fraudDetails = `Document Analysis Results:\n\n`;
                
                // Address verification
                if (!analysis.isLegitimate && !currentFraudScenario.analysis.addressMatch) {
                    fraudDetails += `‚ùå Address Mismatch: Different addresses found on identity documents\n`;
                }
                
                // Bank statement
                if (currentFraudScenario.analysis.statementSuspicious) {
                    fraudDetails += `‚ö†Ô∏è Banking Activity: Limited transaction history detected\n`;
                }
                
                // Credit history
                if (currentFraudScenario.analysis.creditFileAge < 12) {
                    fraudDetails += `‚ö†Ô∏è Credit History: Limited credit file age (${currentFraudScenario.analysis.creditFileAge} months)\n`;
                }
                
                const fraudAlert = {
                    id: 'fraud_' + Date.now(),
                    customerId: customerId,
                    transactionType: 'LOAN_APPLICATION',
                    amount: 500000, // Default loan amount
                    merchantName: document.getElementById('bankSelect')?.value || 'Bank',
                    location: 'Online Application',
                    riskScore: analysis.riskScore,
                    riskLevel: analysis.riskLevel,
                    status: analysis.isLegitimate ? 'REVIEW' : 'FLAGGED',
                    timestamp: Date.now(),
                    reasonEnglish: analysis.isLegitimate 
                        ? `Your loan application requires additional verification. ${analysis.legitimacyReason}. We've identified a path to approval for you.`
                        : `Your application was flagged for fraud review. ${fraudDetails}`,
                    reasonHindi: '‡§Ü‡§™‡§ï‡•á ‡§ã‡§£ ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§æ ‡§ß‡•ã‡§ñ‡§æ‡§ß‡§°‡§º‡•Ä ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à‡•§',
                    reasonTelugu: '‡∞Æ‡±Ä ‡∞∞‡±Å‡∞£ ‡∞¶‡∞∞‡∞ñ‡∞æ‡∞∏‡±ç‡∞§‡±Å ‡∞Æ‡±ã‡∞∏‡∞Ç ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞£ ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞∏‡∞Æ‡±Ä‡∞ï‡±ç‡∞∑‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø‡•§',
                    recommendationEnglish: analysis.recommendation,
                    recommendationHindi: analysis.isLegitimate ? '‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§® ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ö‡§®‡•Å‡§Æ‡•ã‡§¶‡§ø‡§§' : '‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ',
                    recommendationTelugu: analysis.isLegitimate ? '‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞æ‡∞Æ‡∞®‡±ç‡∞® ‡∞ß‡±É‡∞µ‡±Ä‡∞ï‡∞∞‡∞£‡∞§‡±ã ‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø' : '‡∞Æ‡∞æ‡∞®‡±ç‡∞Ø‡±Å‡∞µ‡∞≤‡±ç ‡∞∏‡∞Æ‡±Ä‡∞ï‡±ç‡∞∑ ‡∞Ö‡∞µ‡∞∏‡∞∞‡∞Ç',
                    unusualAmount: false,
                    unusualLocation: false,
                    unusualTime: false,
                    newMerchant: false,
                    multipleAttempts: currentFraudScenario.analysis.recentApplications > 3,
                    deviceMismatch: false,
                    userConfirmed: false,
                    userReportedFraud: false,
                    // Additional fraud-specific fields
                    fraudType: 'DOCUMENT_VERIFICATION',
                    addressMismatch: !currentFraudScenario.analysis.addressMatch,
                    statementSuspicious: currentFraudScenario.analysis.statementSuspicious,
                    biasProtectionApplied: analysis.isLegitimate,
                    pathToApproval: analysis.isLegitimate ? analysis.pathToApproval.join(' | ') : null
                };
                
                await database.ref('fraudAlerts/' + fraudAlert.id).set(fraudAlert);
                
                alert(`üì± Fraud analysis sent to customer app!\n\nCustomer ID: ${customerId}\nRisk Level: ${analysis.riskLevel}\nRecommendation: ${analysis.recommendation}\n\nCustomer will receive full transparency about the analysis.`);
            } catch (error) {
                console.error('Error pushing to Firebase:', error);
                alert('‚ùå Error sending to customer app: ' + error.message);
            }
        }
    </script>
</body>
</html>

